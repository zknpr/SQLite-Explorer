<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Explorer</title>
    <!--HEAD-->
    <style>
:root{--bg-primary: var(--vscode-editor-background, #1e1e1e);--bg-secondary: var(--vscode-sideBar-background, #252526);--bg-tertiary: var(--vscode-input-background, #3c3c3c);--bg-stripe: rgba(255, 255, 255, .02);--text-primary: var(--vscode-editor-foreground, #cccccc);--text-secondary: var(--vscode-descriptionForeground, #888888);--border-color: var(--vscode-panel-border, #454545);--accent-color: var(--vscode-focusBorder, #007acc);--hover-bg: var(--vscode-list-hoverBackground, #2a2d2e);--active-bg: var(--vscode-list-activeSelectionBackground, #094771);--active-text: var(--vscode-list-activeSelectionForeground, #ffffff);--error-color: var(--vscode-errorForeground, #f48771);--success-color: var(--vscode-terminal-ansiGreen, #89d185);--sidebar-width: 220px;--toolbar-height: 36px;--footer-height: 28px;--row-height: 26px;--header-height: 52px;--row-num-width: 50px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--vscode-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);font-size:var(--vscode-font-size, 13px);background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;display:flex}.app-container{display:flex;width:100%;height:100%}.sidebar-panel{width:var(--sidebar-width);min-width:150px;max-width:400px;background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;position:relative}.main-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}.sidebar-header{padding:8px 12px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color)}.sidebar-actions{display:flex;gap:4px}.icon-button{background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:4px;border-radius:3px;display:flex;align-items:center;justify-content:center}.icon-button:hover{background:var(--hover-bg);color:var(--text-primary)}.section-title{padding:6px 12px;font-size:11px;font-weight:600;color:var(--text-secondary);display:flex;align-items:center;cursor:pointer;user-select:none}.section-title:hover{background:var(--hover-bg)}.section-title .arrow{margin-right:4px;transition:transform .15s}.section-title.collapsed .arrow{transform:rotate(-90deg)}.section-title .badge{margin-left:auto;background:var(--bg-tertiary);padding:1px 6px;border-radius:10px;font-size:10px}.item-list{list-style:none;overflow-y:auto}.item-list.hidden{display:none}.list-item{padding:4px 12px 4px 24px;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.list-item:hover{background:var(--hover-bg)}.list-item.selected{background:var(--active-bg);color:var(--active-text)}.list-item .item-icon{opacity:.7;flex-shrink:0}.list-item .item-name{overflow:hidden;text-overflow:ellipsis}.resize-handle{position:absolute;right:0;top:0;bottom:0;width:4px;cursor:col-resize}.resize-handle:hover{background:var(--accent-color)}.toolbar-panel{height:var(--toolbar-height);background:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 8px;gap:8px}.toolbar-left{display:flex;align-items:center;gap:8px}.toolbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}.current-table{display:flex;align-items:center;gap:6px;font-weight:500}.toolbar-button{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px}.toolbar-button:hover{background:var(--hover-bg)}.toolbar-button:disabled{opacity:.5;cursor:not-allowed}.filter-input{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 8px;border-radius:3px;font-size:12px;width:200px}.filter-input:focus{outline:none;border-color:var(--accent-color)}.grid-container{flex:1;overflow:auto;position:relative}.data-grid{border-collapse:collapse;table-layout:fixed}.grid-header{position:sticky;top:0;z-index:10;background:var(--bg-secondary)}.grid-header tr{height:var(--header-height);max-height:var(--header-height)}.header-cell{padding:4px 8px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;color:var(--text-secondary);border-bottom:1px solid var(--border-color);user-select:none;white-space:nowrap;overflow:visible;position:relative;box-sizing:border-box;height:var(--header-height);max-height:var(--header-height);vertical-align:top}.header-content{display:flex;flex-direction:column;height:100%;gap:2px}.header-top{display:flex;align-items:center;gap:4px;height:22px;cursor:pointer;overflow:hidden}.header-bottom{flex:1;display:flex;align-items:center}.header-cell:hover{background:var(--hover-bg)}.header-cell .resize-handle{position:absolute;right:-4px;top:0;height:100%;width:10px;cursor:col-resize;background:transparent;z-index:15}.header-cell .resize-handle:hover,.header-cell .resize-handle.resizing{background:var(--accent-color);background-clip:padding-box;border-left:3px solid transparent;border-right:3px solid transparent}.header-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}.sort-indicator{font-size:10px;margin-left:4px;color:var(--text-secondary)}.key-icon{font-size:12px;margin-right:4px;color:var(--vscode-editorWarning-foreground, #cca700);flex-shrink:0}.header-cell.row-number-header{text-align:center;cursor:pointer}.header-cell.row-number-header:hover{background:var(--hover-bg)}.column-filter{flex:1;min-width:0;padding:2px 6px;font-size:11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:3px 0 0 3px;color:var(--text-primary);box-sizing:border-box;text-transform:none;font-weight:400}.column-filter:focus{outline:none;border-color:var(--accent-color)}.column-filter::placeholder{color:var(--text-secondary);opacity:.7}.filter-apply-btn{padding:2px 6px;font-size:11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-left:none;border-radius:0 3px 3px 0;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}.filter-apply-btn:hover{background:var(--hover-bg);color:var(--text-primary)}.filter-apply-btn .codicon{font-size:12px}.header-cell.pinned,.data-cell.pinned{z-index:5;background-color:var(--bg-secondary)!important}.header-cell.pinned{z-index:12;background-color:var(--bg-secondary)!important}.data-row:hover .data-cell.pinned,.data-row.selected .data-cell.pinned{background-color:var(--bg-secondary)!important}.data-row.pinned{position:sticky;z-index:6}.data-row.pinned td,.data-row.pinned:hover td,.data-row.pinned.selected td,.data-row.pinned td.pinned,.data-row.pinned:hover td.pinned,.data-row.pinned.selected td.pinned{background-color:var(--bg-secondary)!important}.pin-icon{cursor:pointer;opacity:0;margin-left:4px;font-size:12px;vertical-align:middle}.header-cell:hover .pin-icon,.header-cell:hover .select-column-icon,.data-cell.row-number:hover .pin-icon,.pin-icon.pinned{opacity:.5}.pin-icon:hover,.select-column-icon:hover{opacity:1!important}.pin-icon.pinned{opacity:.8}.select-column-icon{opacity:0;cursor:pointer;margin-right:4px;font-size:12px;vertical-align:middle}.data-row{height:var(--row-height);max-height:var(--row-height);background:var(--bg-primary)}.data-row td{background:transparent}.data-row:nth-child(2n){background:var(--bg-stripe)}.data-row:hover{background:var(--hover-bg)}.data-row.selected{background:var(--active-bg)}.data-cell{padding:4px 8px;border-bottom:1px solid var(--border-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-sizing:border-box;height:var(--row-height);max-height:var(--row-height)}.data-cell.row-number{background:var(--bg-secondary);color:var(--text-secondary);text-align:center;font-size:.85em;user-select:none}.data-cell.null-value{color:var(--text-secondary);font-style:italic}.data-cell.cell-selected{background:var(--active-bg)}.header-cell.column-selected{background:var(--active-bg)!important}.header-cell.column-selected .header-text{color:var(--active-text)}.data-cell.editing{padding:0}.cell-input{width:100%;height:100%;padding:4px 8px;border:2px solid var(--accent-color);background:var(--bg-tertiary);color:var(--text-primary);font-family:inherit;font-size:inherit;outline:none}.empty-view{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:12px}.empty-view .empty-icon{font-size:48px;opacity:.5}.empty-view .empty-title{font-size:16px;font-weight:500}.empty-view .empty-desc{font-size:13px}.loading-view{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px}.loading-spinner{width:32px;height:32px;border:3px solid var(--border-color);border-top-color:var(--accent-color);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.footer-panel{height:var(--footer-height);background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;align-items:center;padding:0 12px;font-size:12px}.footer-left{display:flex;align-items:center;gap:12px}.footer-right{margin-left:auto;display:flex;align-items:center;gap:12px}.page-selector{display:flex;align-items:center;gap:4px}.page-selector select{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:2px 6px;border-radius:3px;font-size:11px}.pagination-controls{display:flex;align-items:center;gap:4px}.pagination-controls button{background:none;border:none;color:var(--text-primary);cursor:pointer;padding:2px 6px;border-radius:3px}.pagination-controls button:hover:not(:disabled){background:var(--hover-bg)}.pagination-controls button:disabled{opacity:.3;cursor:not-allowed}.modal-overlay{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-overlay.hidden{display:none}.modal-dialog{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}.modal-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.modal-title{font-weight:600;font-size:14px}.modal-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:18px;padding:4px}.modal-close:hover{color:var(--text-primary)}.modal-body{padding:16px;overflow-y:auto}.modal-footer{padding:12px 16px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:8px}.form-field{margin-bottom:12px}.form-field label{display:block;margin-bottom:4px;font-size:12px;color:var(--text-secondary)}.form-field input,.form-field select{width:100%;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:3px;color:var(--text-primary);font-size:13px}.form-field input:focus,.form-field select:focus{outline:none;border-color:var(--accent-color)}.btn-primary{background:var(--accent-color);border:none;color:#fff;padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.btn-primary:hover{opacity:.9}.btn-secondary{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.btn-secondary:hover{background:var(--hover-bg)}.btn-danger{background:var(--error-color);border:none;color:#fff;padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.cell-preview-modal{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1100}.cell-preview-modal.hidden{display:none}.cell-preview-dialog{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;width:600px;max-width:90vw;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 8px 32px #0000004d}.cell-preview-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:var(--bg-tertiary)}.cell-preview-title{font-weight:600;font-size:13px;color:var(--text-primary);display:flex;align-items:center;gap:8px}.cell-preview-column-name{color:var(--accent-color);font-family:monospace}.cell-preview-type-badge{font-size:10px;padding:2px 6px;background:var(--bg-secondary);border-radius:3px;color:var(--text-secondary);text-transform:uppercase}.cell-preview-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:3px}.cell-preview-close:hover{background:var(--hover-bg);color:var(--text-primary)}.cell-preview-body{flex:1;padding:16px;overflow:auto;min-height:200px;max-height:60vh}.cell-preview-textarea{width:100%;height:100%;min-height:180px;padding:12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-primary);font-family:monospace;font-size:13px;line-height:1.5;resize:vertical;box-sizing:border-box}.cell-preview-textarea:focus{outline:none;border-color:var(--accent-color)}.cell-preview-textarea.readonly{background:var(--bg-secondary);cursor:default}.cell-preview-toolbar{padding:8px 16px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}.cell-preview-toolbar-btn{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 10px;border-radius:3px;cursor:pointer;font-size:11px;display:flex;align-items:center;gap:4px}.cell-preview-toolbar-btn:hover{background:var(--hover-bg)}.cell-preview-toolbar-btn:disabled{opacity:.5;cursor:not-allowed}.cell-preview-toolbar-btn.active{background:var(--accent-color);border-color:var(--accent-color);color:#fff}.cell-preview-footer{padding:12px 16px;border-top:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:var(--bg-tertiary)}.cell-preview-info{font-size:11px;color:var(--text-secondary)}.cell-preview-actions{display:flex;gap:8px}.data-cell .cell-text{display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.data-cell .expand-icon{display:none;position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--text-secondary);background:var(--bg-secondary);padding:2px 4px;border-radius:2px;cursor:pointer;z-index:1}.data-cell .expand-icon:hover{color:var(--text-primary);background:var(--hover-bg)}.data-cell.has-overflow:hover .expand-icon{display:inline-block}.data-cell.has-overflow{cursor:pointer}.data-cell.has-overflow:hover{background:var(--hover-bg)}

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Panel -->
        <div class="sidebar-panel" id="sidebarPanel">
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-actions">
                    <button class="icon-button" onclick="reloadFromDisk()" title="Reload">
                        <span class="codicon codicon-refresh"></span>
                    </button>
                </div>
            </div>

            <!-- Tables Section -->
            <div class="section-title" data-section="tables" onclick="toggleSection('tables')">
                <span class="arrow">▼</span>
                <span>Tables</span>
                <span class="badge" id="tablesBadge">0</span>
                <button class="icon-button" onclick="event.stopPropagation(); openCreateTableModal()" title="Create Table" style="margin-left: auto;">
                    <span class="codicon codicon-add"></span>
                </button>
            </div>
            <ul class="item-list" id="tablesList"></ul>

            <!-- Views Section -->
            <div class="section-title collapsed" data-section="views" onclick="toggleSection('views')">
                <span class="arrow">▼</span>
                <span>Views</span>
                <span class="badge" id="viewsBadge">0</span>
            </div>
            <ul class="item-list hidden" id="viewsList"></ul>

            <!-- Indexes Section -->
            <div class="section-title collapsed" data-section="indexes" onclick="toggleSection('indexes')">
                <span class="arrow">▼</span>
                <span>Indexes</span>
                <span class="badge" id="indexesBadge">0</span>
            </div>
            <ul class="item-list hidden" id="indexesList"></ul>

            <div class="resize-handle" id="resizeHandle"></div>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Toolbar -->
            <div class="toolbar-panel">
                <div class="toolbar-left">
                    <div class="current-table" id="currentTable">
                        <span class="codicon codicon-table"></span>
                        <span id="tableNameLabel">No table selected</span>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button class="toolbar-button" id="btnAddRow" onclick="openAddRowModal()" disabled>
                        <span class="codicon codicon-add"></span> Add Row
                    </button>
                    <button class="toolbar-button" id="btnAddColumn" onclick="openAddColumnModal()" disabled>
                        <span class="codicon codicon-insert"></span> Add Column
                    </button>
                    <button class="toolbar-button" id="btnDeleteRows" onclick="openDeleteModal()" disabled>
                        <span class="codicon codicon-trash"></span> Delete
                    </button>
                    <button class="toolbar-button" id="btnExport" onclick="exportCurrentTable()" disabled>
                        <span class="codicon codicon-export"></span> Export
                    </button>
                    <input type="text" class="filter-input" id="filterInput" placeholder="Filter..." onkeyup="onFilterChange()">
                </div>
            </div>

            <!-- Grid Container -->
            <div class="grid-container" id="gridContainer">
                <div class="loading-view" id="loadingView">
                    <div class="loading-spinner"></div>
                    <span>Connecting to database...</span>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer-panel">
                <div class="footer-left">
                    <span id="statusText">Ready</span>
                </div>
                <div class="footer-right">
                    <div class="page-selector">
                        <span>Rows:</span>
                        <select id="pageSizeSelect" onchange="onPageSizeChange()">
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="500" selected>500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <button id="btnFirst" onclick="goToPage(0)" disabled>⏮</button>
                        <button id="btnPrev" onclick="goToPage(currentPageIndex - 1)" disabled>◀</button>
                        <span id="pageIndicator">0 / 0</span>
                        <button id="btnNext" onclick="goToPage(currentPageIndex + 1)" disabled>▶</button>
                        <button id="btnLast" onclick="goToPage(totalPageCount - 1)" disabled>⏭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Row Modal -->
    <div class="modal-overlay hidden" id="addRowModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Add New Row</span>
                <button class="modal-close" onclick="closeModal('addRowModal')">&times;</button>
            </div>
            <div class="modal-body" id="addRowForm"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addRowModal')">Cancel</button>
                <button class="btn-primary" onclick="submitAddRow()">Add Row</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay hidden" id="deleteModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Confirm Delete</span>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">Are you sure you want to delete the selected rows?</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn-danger" onclick="submitDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Create Table Modal -->
    <div class="modal-overlay hidden" id="createTableModal">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-header">
                <span class="modal-title">Create New Table</span>
                <button class="modal-close" onclick="closeModal('createTableModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Table Name</label>
                    <input type="text" id="newTableName" placeholder="my_table">
                </div>
                <div class="form-field">
                    <label>Columns</label>
                    <div id="columnDefinitions"></div>
                    <button class="btn-secondary" onclick="addColumnDefinition()" style="margin-top: 8px;">+ Add Column</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createTableModal')">Cancel</button>
                <button class="btn-primary" onclick="submitCreateTable()">Create Table</button>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal-overlay hidden" id="addColumnModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Add Column</span>
                <button class="modal-close" onclick="closeModal('addColumnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Column Name</label>
                    <input type="text" id="newColumnName" placeholder="column_name">
                </div>
                <div class="form-field">
                    <label>Type</label>
                    <select id="newColumnType">
                        <option value="TEXT">TEXT</option>
                        <option value="INTEGER">INTEGER</option>
                        <option value="REAL">REAL</option>
                        <option value="BLOB">BLOB</option>
                        <option value="NUMERIC">NUMERIC</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>Default Value (optional)</label>
                    <input type="text" id="newColumnDefault" placeholder="NULL">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addColumnModal')">Cancel</button>
                <button class="btn-primary" onclick="submitAddColumn()">Add Column</button>
            </div>
        </div>
    </div>

    <!-- Cell Preview/Edit Modal - Floating window for viewing and editing large cell values -->
    <div class="cell-preview-modal hidden" id="cellPreviewModal">
        <div class="cell-preview-dialog">
            <div class="cell-preview-header">
                <div class="cell-preview-title">
                    <span>Column:</span>
                    <span class="cell-preview-column-name" id="cellPreviewColumnName"></span>
                    <span class="cell-preview-type-badge" id="cellPreviewTypeBadge"></span>
                </div>
                <button class="cell-preview-close" onclick="closeCellPreview()">&times;</button>
            </div>
            <div class="cell-preview-toolbar">
                <button class="cell-preview-toolbar-btn" id="formatJsonBtn" onclick="formatCellPreviewJson()" title="Format as JSON">
                    <span class="codicon codicon-json"></span> Format JSON
                </button>
                <button class="cell-preview-toolbar-btn" id="compactJsonBtn" onclick="compactCellPreviewJson()" title="Compact JSON">
                    <span class="codicon codicon-fold"></span> Compact
                </button>
                <button class="cell-preview-toolbar-btn" id="wrapTextBtn" onclick="toggleCellPreviewWrap()" title="Toggle word wrap">
                    <span class="codicon codicon-word-wrap"></span> Wrap
                </button>
            </div>
            <div class="cell-preview-body">
                <textarea class="cell-preview-textarea" id="cellPreviewTextarea" spellcheck="false"></textarea>
            </div>
            <div class="cell-preview-footer">
                <div class="cell-preview-info">
                    <span id="cellPreviewCharCount">0 characters</span>
                    <span id="cellPreviewReadonlyBadge" style="display:none;margin-left:8px;color:var(--warning-color);">Read-only (View)</span>
                </div>
                <div class="cell-preview-actions">
                    <button class="btn-secondary" onclick="closeCellPreview()">Cancel</button>
                    <button class="btn-primary" id="cellPreviewSaveBtn" onclick="saveCellPreview()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
let isDbConnected=!1,selectedTable=null,selectedTableType="table",currentPageIndex=0,rowsPerPage=500,totalRecordCount=0,totalPageCount=1,tableColumns=[],sortedColumn=null,sortAscending=!0,filterQuery="",filterTimer=null,selectedRowIds=new Set,gridData=[],editingCellInfo=null,activeCellInput=null,isSavingCell=!1,isLoadingData=!1,lastDoubleClickTime=0,isTransitioningEdit=!1,transitionLockTimeout=null,selectedCells=[],lastSelectedCell=null,columnWidths={},resizingColumn=null,resizeStartX=0,resizeStartWidth=0,columnFilters={},pinnedColumns=new Set,pinnedRowIds=new Set,cellPreviewInfo=null,cellPreviewWrapEnabled=!0,selectedColumns=new Set,schemaCache={tables:[],views:[],indexes:[]},backendApi=null;function getRowDataOffset(){return selectedTableType==="table"?1:0}function getRowId(e,t){return selectedTableType==="table"?e[0]:currentPageIndex*rowsPerPage+t}function getCellValue(e,t){return e[t+getRowDataOffset()]}const vscodeApi=typeof acquireVsCodeApi<"u"?acquireVsCodeApi():null;let rpcMessageId=0;const pendingRpcCalls=new Map;function sendRpcRequest(e,t){return new Promise((n,l)=>{const o=`rpc_${++rpcMessageId}_${Date.now()}`,s=setTimeout(()=>{pendingRpcCalls.has(o)&&(pendingRpcCalls.delete(o),l(new Error(`RPC timeout: ${e}`)))},3e4);pendingRpcCalls.set(o,{resolve:n,reject:l,timeoutId:s}),vscodeApi&&vscodeApi.postMessage({channel:"rpc",content:{kind:"invoke",messageId:o,targetMethod:e,payload:t}})})}const webviewMethods={async refreshContent(e){return isDbConnected&&selectedTable&&await loadTableData(),{success:!0}},async updateColorScheme(e){return document.documentElement.style.colorScheme=e,{success:!0}},async updateAutoCommit(e){return{success:!0}},async updateCellEditBehavior(e){return{success:!0}},async updateViewState(e){return{success:!0}},async updateCopilotActive(e){return{success:!0}}};window.addEventListener("message",e=>{const t=e.data;if(t&&t.kind==="invoke"){const{correlationId:l,methodName:o,parameters:s}=t,a=webviewMethods[o];typeof a=="function"?Promise.resolve(a.apply(webviewMethods,s||[])).then(r=>{vscodeApi&&vscodeApi.postMessage({kind:"result",correlationId:l,payload:r})}).catch(r=>{vscodeApi&&vscodeApi.postMessage({kind:"result",correlationId:l,errorText:r instanceof Error?r.message:String(r)})}):vscodeApi&&vscodeApi.postMessage({kind:"result",correlationId:l,errorText:`Unknown method: ${o}`});return}if(!t||t.channel!=="rpc")return;const n=t.content;if(n&&n.kind==="response"){const l=pendingRpcCalls.get(n.messageId);l&&(clearTimeout(l.timeoutId),pendingRpcCalls.delete(n.messageId),n.success?l.resolve(n.data):l.reject(new Error(n.errorMessage||"RPC failed")))}}),backendApi={initialize:()=>sendRpcRequest("initialize",[]),exec:(e,t)=>sendRpcRequest("exec",[e,t]),exportDb:e=>sendRpcRequest("exportDb",[e]),refreshFile:()=>sendRpcRequest("refreshFile",[]),fireEditEvent:e=>sendRpcRequest("fireEditEvent",[e]),exportTable:(e,t)=>sendRpcRequest("exportTable",[e,t])};async function initializeApp(){try{updateStatus("Connecting to database...");const e=await backendApi.initialize();if(!e||!e.connected)throw new Error("Failed to connect to database");isDbConnected=!0,console.log("Connected to database:",e.filename),await backendApi.exec("SELECT 1"),await refreshSchema(),updateStatus("Ready"),showEmptyState()}catch(e){console.error("Init error:",e),showErrorState(e.message)}}async function refreshSchema(){if(isDbConnected)try{const e=await backendApi.exec("SELECT name FROM sqlite_schema WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name"),t=await backendApi.exec("SELECT name FROM sqlite_schema WHERE type='view' ORDER BY name"),n=await backendApi.exec("SELECT name, tbl_name FROM sqlite_schema WHERE type='index' AND name NOT LIKE 'sqlite_%' ORDER BY name");schemaCache.tables=(e[0]?.records||[]).map(l=>({name:l[0]})),schemaCache.views=(t[0]?.records||[]).map(l=>({name:l[0]})),schemaCache.indexes=(n[0]?.records||[]).map(l=>({name:l[0],table:l[1]})),renderSidebar()}catch(e){console.error("Error loading schema:",e),updateStatus("Error loading schema")}}function renderSidebar(){document.getElementById("tablesBadge").textContent=schemaCache.tables.length,document.getElementById("viewsBadge").textContent=schemaCache.views.length,document.getElementById("indexesBadge").textContent=schemaCache.indexes.length;const e=document.getElementById("tablesList");schemaCache.tables.length===0?e.innerHTML='<li class="list-item" style="opacity:0.5">No tables</li>':e.innerHTML=schemaCache.tables.map(l=>`
            <li class="list-item ${selectedTable===l.name&&selectedTableType==="table"?"selected":""}"
                onclick="selectTableItem('${escapeHtml(l.name)}', 'table')"
                title="${escapeHtml(l.name)}">
                <span class="item-icon codicon codicon-table"></span>
                <span class="item-name">${escapeHtml(l.name)}</span>
            </li>
        `).join("");const t=document.getElementById("viewsList");schemaCache.views.length===0?t.innerHTML='<li class="list-item" style="opacity:0.5">No views</li>':t.innerHTML=schemaCache.views.map(l=>`
            <li class="list-item ${selectedTable===l.name&&selectedTableType==="view"?"selected":""}"
                onclick="selectTableItem('${escapeHtml(l.name)}', 'view')"
                title="${escapeHtml(l.name)}">
                <span class="item-icon codicon codicon-eye"></span>
                <span class="item-name">${escapeHtml(l.name)}</span>
            </li>
        `).join("");const n=document.getElementById("indexesList");schemaCache.indexes.length===0?n.innerHTML='<li class="list-item" style="opacity:0.5">No indexes</li>':n.innerHTML=schemaCache.indexes.map(l=>`
            <li class="list-item" title="${escapeHtml(l.name)} on ${escapeHtml(l.table)}">
                <span class="item-icon codicon codicon-list-tree"></span>
                <span class="item-name">${escapeHtml(l.name)}</span>
            </li>
        `).join("")}function toggleSection(e){const t=document.querySelector(`[data-section="${e}"]`),n=document.getElementById(`${e}List`);t.classList.toggle("collapsed"),n.classList.toggle("hidden")}async function selectTableItem(e,t="table"){selectedTable=e,selectedTableType=t,currentPageIndex=0,sortedColumn=null,sortAscending=!0,columnWidths={},columnFilters={},pinnedColumns.clear(),pinnedRowIds.clear(),filterQuery="",selectedRowIds.clear(),selectedCells=[],selectedColumns.clear(),lastSelectedCell=null,document.getElementById("filterInput").value="",document.getElementById("tableNameLabel").textContent=e,updateToolbarButtons(),renderSidebar(),await loadTableColumns(),await loadTableData()}async function loadTableColumns(){if(selectedTable)try{tableColumns=((await backendApi.exec(`PRAGMA table_info(${escapeIdentifier(selectedTable)})`))[0]?.records||[]).map(t=>({cid:t[0],name:t[1],type:t[2]||"TEXT",notnull:t[3],defaultValue:t[4],isPrimaryKey:t[5]}))}catch(e){console.error("Error loading columns:",e),tableColumns=[]}}async function loadTableData(){if(!selectedTable||!isDbConnected||isLoadingData)return;isLoadingData=!0;const e=document.getElementById("gridContainer"),t=e.scrollLeft,n=e.scrollTop;showLoading();try{const l=[];if(filterQuery){const f=tableColumns.map(m=>`${escapeIdentifier(m.name)} LIKE '%${filterQuery.replace(/'/g,"''")}%'`).join(" OR ");l.push(`(${f})`)}for(const[f,m]of Object.entries(columnFilters))if(m&&m.trim()){const p=m.replace(/'/g,"''");l.push(`${escapeIdentifier(f)} LIKE '%${p}%'`)}const o=l.length>0?` WHERE ${l.join(" AND ")}`:"",s=`SELECT COUNT(*) FROM ${escapeIdentifier(selectedTable)}${o}`;totalRecordCount=(await backendApi.exec(s))[0]?.records?.[0]?.[0]||0,totalPageCount=Math.max(1,Math.ceil(totalRecordCount/rowsPerPage)),currentPageIndex>=totalPageCount&&(currentPageIndex=Math.max(0,totalPageCount-1));const r=tableColumns.map(f=>escapeIdentifier(f.name)).join(", ");let d=selectedTableType==="table"?`SELECT rowid AS _rowid_, ${r} FROM ${escapeIdentifier(selectedTable)}${o}`:`SELECT ${r} FROM ${escapeIdentifier(selectedTable)}${o}`;sortedColumn&&(d+=` ORDER BY ${escapeIdentifier(sortedColumn)} ${sortAscending?"ASC":"DESC"}`),d+=` LIMIT ${rowsPerPage} OFFSET ${currentPageIndex*rowsPerPage}`,gridData=(await backendApi.exec(d))[0]?.records||[],renderDataGrid(),e.scrollLeft=t,e.scrollTop=n,updatePagination(),updateStatus(`${totalRecordCount} records`)}catch(l){console.error("Error loading data:",l),updateStatus(`Error: ${l.message}`),showErrorState(l.message)}finally{isLoadingData=!1}}function renderDataGrid(){const e=document.getElementById("gridContainer"),t=e.scrollLeft,n=e.scrollTop,l=Object.values(columnFilters).some(i=>i&&i.trim()!=="");if(gridData.length===0&&!l&&tableColumns.length===0){e.innerHTML=`
            <div class="empty-view">
                <span class="empty-icon codicon codicon-database"></span>
                <span class="empty-title">No data</span>
                <span class="empty-desc">This table is empty</span>
            </div>
        `;return}let o='<table class="data-grid"><thead class="grid-header"><tr>';if(Object.keys(columnWidths).length===0&&gridData.length>0)for(const i of tableColumns){const y=i.name.length,g=i.isPrimaryKey?86:70,$=y*8+g;columnWidths[i.name]=Math.max(80,Math.min(250,$))}const s=[...tableColumns.filter(i=>pinnedColumns.has(i.name)),...tableColumns.filter(i=>!pinnedColumns.has(i.name))],a=new Map;let r=50;for(const i of s)pinnedColumns.has(i.name)&&(a.set(i.name,r),r+=columnWidths[i.name]||120);const u=new Map;tableColumns.forEach((i,y)=>u.set(i.name,y)),o+='<th class="header-cell row-number-header" style="width:50px;position:sticky;left:0;z-index:11;background:var(--bg-secondary)" onclick="onSelectAllClick(event)" title="Click to select all rows"><div class="header-content"><div class="header-top" style="height:100%;justify-content:center">#</div></div></th>';for(const i of s){const y=sortedColumn===i.name,g=pinnedColumns.has(i.name),$=g?"pinned":"",v=a.get(i.name),L=g?`position:sticky;left:${v}px;`:"",x=columnWidths[i.name]||120,h=columnFilters[i.name]||"",N=y?`<span class="sort-indicator">${sortAscending?"\u25B2":"\u25BC"}</span>`:"",b=i.isPrimaryKey?'<span class="key-icon codicon codicon-key" title="Primary Key"></span>':"";o+=`<th class="header-cell ${$}" style="width:${x}px;min-width:${x}px;max-width:${x}px;${L}" data-column="${escapeHtml(i.name)}">`,o+='<div class="header-content">',o+=`<div class="header-top" onclick="onColumnSort('${escapeHtml(i.name)}')">`,o+=`${b}<span class="header-text">${escapeHtml(i.name)}${N}</span>`,o+=`<span class="select-column-icon codicon codicon-selection" onclick="event.stopPropagation(); onColumnHeaderClick(event, '${escapeHtml(i.name)}')" title="Select entire column"></span>`,o+=`<span class="pin-icon codicon codicon-pin ${g?"pinned":""}" onclick="event.stopPropagation(); toggleColumnPin(event, '${escapeHtml(i.name)}')" title="${g?"Unpin column":"Pin column"}"></span>`,o+="</div>",o+='<div class="header-bottom" onclick="event.stopPropagation()">',o+=`<input type="text" class="column-filter" data-column="${escapeHtml(i.name)}" value="${escapeHtml(h)}" placeholder="Filter..." onclick="event.stopPropagation()" onkeydown="onColumnFilterKeydown(event, '${escapeHtml(i.name)}')">`,o+=`<button class="filter-apply-btn" onclick="event.stopPropagation(); applyColumnFilter('${escapeHtml(i.name)}')" title="Apply filter (Enter)"><span class="codicon codicon-search"></span></button>`,o+="</div>",o+="</div>",o+=`<div class="resize-handle" onmousedown="event.stopPropagation(); startColumnResize(event, '${escapeHtml(i.name)}')"></div>`,o+="</th>"}o+="</tr></thead><tbody>";const d=51,c=25,f=50,m=[];for(let i=0;i<gridData.length;i++){const y=getRowId(gridData[i],i);pinnedRowIds.has(y)&&m.push({rowIdx:i,rowId:y,row:gridData[i]})}const p=new Map;for(let i=0;i<m.length;i++){const y=d+i*c;p.set(m[i].rowId,y)}function E(i,y,g){const $=selectedRowIds.has(g),v=pinnedRowIds.has(g),L=p.get(g),x=v?`top:${L}px;`:"";let h=`<tr class="data-row ${$?"selected":""} ${v?"pinned":""}" style="${x}" data-rowid="${g}" data-rowidx="${i}" onclick="onRowClick(event, ${g}, ${i})">`;h+=`<td class="data-cell row-number" style="width:50px;position:sticky;left:0;z-index:${v?8:2};" onclick="onRowNumberClick(event, ${g})">`,h+=`${currentPageIndex*rowsPerPage+i+1}`,h+=`<span class="pin-icon codicon codicon-pin ${v?"pinned":""}" onclick="toggleRowPin(event, ${g})" title="${v?"Unpin row":"Pin row"}"></span>`,h+="</td>";for(let b=0;b<s.length;b++){const I=s[b],C=u.get(I.name),T=getCellValue(y,C),P=formatCellValue(T),R=T==null,A=selectedCells.some(M=>M.rowIdx===i&&M.colIdx===C),B=pinnedColumns.has(I.name),D=a.get(I.name),q=B?`position:sticky;left:${D}px;`:"",k=!R&&!(T instanceof Uint8Array),S=columnWidths[I.name]||120,O=`width:${S}px;min-width:${S}px;max-width:${S}px;${k?"position:relative;":""}${q}`;h+=`<td class="data-cell ${R?"null-value":""} ${A?"cell-selected":""} ${B?"pinned":""}" style="${O}" data-rowidx="${i}" data-colidx="${C}" onclick="onCellClick(event, ${i}, ${C}, ${g})" ondblclick="onCellDoubleClick(event, ${i}, ${C}, ${g})">`,h+=`<span class="cell-text">${P}</span>`,k&&(h+=`<span class="expand-icon codicon codicon-link-external" onclick="event.stopPropagation(); openCellPreview(${i}, ${C}, ${g})" title="View full content"></span>`),h+="</td>"}return h+="</tr>",h}const w=[...gridData.map((i,y)=>({idx:y,rowId:getRowId(i,y)})).filter(i=>pinnedRowIds.has(i.rowId)),...gridData.map((i,y)=>({idx:y,rowId:getRowId(i,y)})).filter(i=>!pinnedRowIds.has(i.rowId))];for(const{idx:i,rowId:y}of w){const g=gridData[i];o+=E(i,g,y)}if(gridData.length===0&&l){const i=s.length+1;o+=`<tr class="no-results-row"><td colspan="${i}" style="text-align:center;padding:20px;color:var(--text-secondary);">No rows match the current filter. Modify or clear filters above.</td></tr>`}o+="</tbody></table>",e.innerHTML=o,e.scrollLeft=t,e.scrollTop=n,updateCellOverflowStates()}function updateCellOverflowStates(){const e=document.querySelectorAll(".data-cell");for(const t of e){const n=t.querySelector(".cell-text");if(!n){t.classList.remove("has-overflow");continue}const l=n.scrollWidth>n.clientWidth;t.classList.toggle("has-overflow",l)}}function formatCellValue(e){return e==null?"NULL":e instanceof Uint8Array?"[BLOB]":typeof e=="string"&&e.length>100?escapeHtml(e.substring(0,100))+"...":escapeHtml(String(e))}let cellClickTimer=null;function onCellClick(e,t,n,l){try{if(e.stopPropagation(),isLoadingData||isSavingCell||isTransitioningEdit||editingCellInfo)return;const o=gridData[t]?getCellValue(gridData[t],n):null,s={rowIdx:t,colIdx:n,rowId:l,value:o};if((e.metaKey||e.ctrlKey)&&e.shiftKey&&lastSelectedCell){selectedRowIds.clear();const a=Math.min(lastSelectedCell.rowIdx,t),r=Math.max(lastSelectedCell.rowIdx,t),u=Math.min(lastSelectedCell.colIdx,n),d=Math.max(lastSelectedCell.colIdx,n);for(let c=a;c<=r;c++)for(let f=u;f<=d;f++){const m=gridData[c]?getRowId(gridData[c],c):null,p=gridData[c]?getCellValue(gridData[c],f):null;selectedCells.findIndex(w=>w.rowIdx===c&&w.colIdx===f)===-1&&selectedCells.push({rowIdx:c,colIdx:f,rowId:m,value:p})}updateCellSelectionUI(),updateRowSelectionUI(),updateToolbarButtons();return}if(e.shiftKey&&lastSelectedCell){selectedRowIds.clear(),selectedCells=[],selectedColumns.clear();const a=Math.min(lastSelectedCell.rowIdx,t),r=Math.max(lastSelectedCell.rowIdx,t),u=Math.min(lastSelectedCell.colIdx,n),d=Math.max(lastSelectedCell.colIdx,n);for(let c=a;c<=r;c++)for(let f=u;f<=d;f++){const m=gridData[c]?getRowId(gridData[c],c):null,p=gridData[c]?getCellValue(gridData[c],f):null;selectedCells.push({rowIdx:c,colIdx:f,rowId:m,value:p})}updateCellSelectionUI(),updateRowSelectionUI(),updateToolbarButtons();return}if(e.metaKey||e.ctrlKey){selectedRowIds.clear();const a=selectedCells.findIndex(r=>r.rowIdx===t&&r.colIdx===n);a!==-1?selectedCells.splice(a,1):(selectedCells.push(s),lastSelectedCell=s),updateCellSelectionUI(),updateRowSelectionUI(),updateToolbarButtons();return}cellClickTimer&&(clearTimeout(cellClickTimer),cellClickTimer=null),cellClickTimer=setTimeout(()=>{try{if(cellClickTimer=null,editingCellInfo||isLoadingData||isSavingCell||isTransitioningEdit||!gridData[t])return;const a=getCellValue(gridData[t],n),r={rowIdx:t,colIdx:n,rowId:l,value:a};selectedCells.length===1&&selectedCells[0].rowIdx===t&&selectedCells[0].colIdx===n?(selectedCells=[],lastSelectedCell=null,selectedColumns.clear()):(selectedCells=[r],lastSelectedCell=r,selectedRowIds.clear(),selectedColumns.clear()),updateCellSelectionUI(),updateRowSelectionUI(),updateToolbarButtons()}catch(a){console.error("Error in cell click timeout:",a)}},80)}catch(o){console.error("Error in onCellClick:",o)}}function updateCellSelectionUI(){const e=new Set,t=new Map;for(const o of selectedCells)e.add(`${o.rowIdx},${o.colIdx}`),t.set(o.colIdx,(t.get(o.colIdx)||0)+1);const n=document.querySelectorAll(".data-cell[data-rowidx]");for(const o of n){const s=o.dataset.rowidx,a=o.dataset.colidx,r=`${s},${a}`;e.has(r)?o.classList.add("cell-selected"):o.classList.remove("cell-selected")}const l=document.querySelectorAll(".header-cell[data-column]");for(const o of l){const s=o.dataset.column,a=tableColumns.findIndex(u=>u.name===s),r=t.get(a)||0;gridData.length>0&&r===gridData.length?o.classList.add("column-selected"):o.classList.remove("column-selected")}}async function onCellDoubleClick(e,t,n,l){try{if(e.stopPropagation(),e.preventDefault(),editingCellInfo||isTransitioningEdit)return;isTransitioningEdit=!0,transitionLockTimeout&&clearTimeout(transitionLockTimeout),transitionLockTimeout=setTimeout(()=>{isTransitioningEdit&&(console.warn("Transition lock was stuck - force releasing"),isTransitioningEdit=!1),transitionLockTimeout=null},500);const o=(f=50)=>{transitionLockTimeout&&(clearTimeout(transitionLockTimeout),transitionLockTimeout=null),setTimeout(()=>{isTransitioningEdit=!1},f)},s=Date.now();if(s-lastDoubleClickTime<300){o();return}if(lastDoubleClickTime=s,isSavingCell||isLoadingData){o();return}if(cellClickTimer&&(clearTimeout(cellClickTimer),cellClickTimer=null),rowClickTimer&&(clearTimeout(rowClickTimer),rowClickTimer=null),selectedTableType!=="table"){updateStatus("Views are read-only"),o();return}selectedCells=[],lastSelectedCell=null,selectedRowIds.clear(),selectedColumns.clear(),updateCellSelectionUI(),updateRowSelectionUI();const a=e.target.closest("td.data-cell");if(!a){o();return}const r=parseInt(a.dataset.rowidx,10),u=parseInt(a.dataset.colidx,10);if(isNaN(r)||isNaN(u)||r!==t||u!==n){console.warn("Cell mismatch: expected",t,n,"got",r,u),o();return}const d=tableColumns[n];if(!d){o();return}if(!gridData[t]){o();return}const c=getCellValue(gridData[t],n);if(editingCellInfo={rowIdx:t,colIdx:n,rowId:l,columnName:d.name,originalValue:c},a.classList.remove("cell-selected"),a.classList.add("editing"),a.innerHTML=`<input type="text" class="cell-input" value="${c===null?"":escapeHtml(String(c))}">`,activeCellInput=a.querySelector("input"),!activeCellInput){console.error("Failed to create cell input"),editingCellInfo=null,a.classList.remove("editing"),o();return}activeCellInput.focus(),activeCellInput.select(),activeCellInput.addEventListener("keydown",onCellInputKeydown),activeCellInput.addEventListener("blur",onCellInputBlur),transitionLockTimeout&&(clearTimeout(transitionLockTimeout),transitionLockTimeout=null),setTimeout(()=>{isTransitioningEdit=!1},100)}catch(o){console.error("Error in onCellDoubleClick:",o),isTransitioningEdit=!1,isSavingCell=!1,transitionLockTimeout&&(clearTimeout(transitionLockTimeout),transitionLockTimeout=null),cleanupCellEdit(),updateStatus("Error: "+(o.message||String(o)))}}function onCellInputKeydown(e){e.key==="Enter"?(e.preventDefault(),saveCellEdit()):e.key==="Escape"&&(e.preventDefault(),cancelCellEdit())}function onCellInputBlur(){setTimeout(()=>{editingCellInfo&&saveCellEdit()},100)}async function saveCellEdit(){if(isSavingCell||!editingCellInfo||!activeCellInput)return;const{rowIdx:e,colIdx:t,rowId:n,columnName:l,originalValue:o}=editingCellInfo,s=activeCellInput.value,a=o===null?"":String(o);if(s===a){cancelCellEdit();return}const r=tableColumns[t],u=r&&r.notnull===1;let d;s===""?u?d="''":d="NULL":!isNaN(Number(s))&&s.trim()!==""?d=s:d=`'${s.replace(/'/g,"''")}'`;const c=`UPDATE ${escapeIdentifier(selectedTable)} SET ${escapeIdentifier(l)} = ${d} WHERE rowid = ${validateRowId(n)}`;try{isSavingCell=!0,updateStatus("Saving..."),await backendApi.exec(c);const f=s===""?u?"":null:!isNaN(Number(s))&&s.trim()!==""?Number(s):s;await backendApi.fireEditEvent({label:`Edit ${l}`,description:`Edit ${l}`,modificationType:"cell_update",targetTable:selectedTable,targetRowId:n,targetColumn:l,previousValue:o,newValue:f}),gridData[e][t+getRowDataOffset()]=f,cleanupCellEdit(),await loadTableData(),updateStatus("Saved")}catch(f){console.error("Save failed:",f);let m=f.message||String(f);m.includes("FOREIGN KEY constraint failed")?m="Foreign key constraint: the value must reference an existing record in the related table":m.includes("UNIQUE constraint failed")?m="Unique constraint: this value already exists in the column":m.includes("NOT NULL constraint failed")?m="Not null constraint: this column cannot be empty":m.includes("CHECK constraint failed")&&(m="Check constraint: the value does not satisfy the column requirements"),updateStatus(`Save failed: ${m}`)}finally{isSavingCell=!1}}function cancelCellEdit(){cleanupCellEdit(),renderDataGrid()}function cleanupCellEdit(){activeCellInput&&(activeCellInput.removeEventListener("keydown",onCellInputKeydown),activeCellInput.removeEventListener("blur",onCellInputBlur),activeCellInput=null),editingCellInfo=null}function openCellPreview(e,t,n){editingCellInfo&&cancelCellEdit();const l=tableColumns[t];if(!l)return;const o=gridData[e];if(!o)return;const s=getCellValue(o,t);cellPreviewInfo={rowIdx:e,colIdx:t,rowId:n,columnName:l.name,originalValue:s};const a=document.getElementById("cellPreviewModal"),r=document.getElementById("cellPreviewColumnName"),u=document.getElementById("cellPreviewTypeBadge"),d=document.getElementById("cellPreviewTextarea"),c=document.getElementById("cellPreviewCharCount"),f=document.getElementById("cellPreviewReadonlyBadge"),m=document.getElementById("cellPreviewSaveBtn"),p=document.getElementById("wrapTextBtn");r.textContent=l.name,u.textContent=l.type||"TEXT";let E="";s==null?E="":s instanceof Uint8Array?E="[BLOB: "+Array.from(s).map(i=>i.toString(16).padStart(2,"0")).join(" ")+"]":E=String(s),d.value=E;const w=selectedTableType!=="table";d.readOnly=w,d.classList.toggle("readonly",w),f.style.display=w?"inline":"none",m.disabled=w,m.style.display=w?"none":"inline-block",updateCellPreviewCharCount(),d.style.whiteSpace=cellPreviewWrapEnabled?"pre-wrap":"pre",d.style.overflowX=cellPreviewWrapEnabled?"hidden":"auto",p.classList.toggle("active",cellPreviewWrapEnabled),a.classList.remove("hidden"),d.focus(),d.addEventListener("keydown",onCellPreviewKeydown)}function onCellPreviewKeydown(e){e.key==="Escape"?(e.preventDefault(),closeCellPreview()):e.key==="Enter"&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),saveCellPreview())}function updateCellPreviewCharCount(){const e=document.getElementById("cellPreviewTextarea"),t=document.getElementById("cellPreviewCharCount"),n=e.value.length;t.textContent=`${n.toLocaleString()} character${n!==1?"s":""}`}function closeCellPreview(){const e=document.getElementById("cellPreviewModal");document.getElementById("cellPreviewTextarea").removeEventListener("keydown",onCellPreviewKeydown),e.classList.add("hidden"),cellPreviewInfo=null}async function saveCellPreview(){if(!cellPreviewInfo)return;if(selectedTableType!=="table"){updateStatus("Views are read-only");return}const{rowIdx:e,colIdx:t,rowId:n,columnName:l,originalValue:o}=cellPreviewInfo,a=document.getElementById("cellPreviewTextarea").value,r=o===null?"":String(o);if(a===r){closeCellPreview();return}const u=tableColumns[t],d=u&&u.notnull===1;let c;a===""?d?c="''":c="NULL":!isNaN(Number(a))&&a.trim()!==""?c=a:c=`'${a.replace(/'/g,"''")}'`;const f=`UPDATE ${escapeIdentifier(selectedTable)} SET ${escapeIdentifier(l)} = ${c} WHERE rowid = ${validateRowId(n)}`;try{updateStatus("Saving..."),await backendApi.exec(f);const m=a===""?d?"":null:!isNaN(Number(a))&&a.trim()!==""?Number(a):a;await backendApi.fireEditEvent({label:`Edit ${l}`,description:`Edit ${l}`,modificationType:"cell_update",targetTable:selectedTable,targetRowId:n,targetColumn:l,previousValue:o,newValue:m}),gridData[e][t+getRowDataOffset()]=m,closeCellPreview(),await loadTableData(),updateStatus("Saved")}catch(m){console.error("Save failed:",m);let p=m.message||String(m);p.includes("FOREIGN KEY constraint failed")?p="Foreign key constraint: the value must reference an existing record in the related table":p.includes("UNIQUE constraint failed")?p="Unique constraint: this value already exists in the column":p.includes("NOT NULL constraint failed")?p="Not null constraint: this column cannot be empty":p.includes("CHECK constraint failed")&&(p="Check constraint: the value does not satisfy the column requirements"),updateStatus(`Save failed: ${p}`)}}function formatCellPreviewJson(){const e=document.getElementById("cellPreviewTextarea");try{const t=JSON.parse(e.value);e.value=JSON.stringify(t,null,2),updateCellPreviewCharCount()}catch{updateStatus("Content is not valid JSON")}}function compactCellPreviewJson(){const e=document.getElementById("cellPreviewTextarea");try{const t=JSON.parse(e.value);e.value=JSON.stringify(t),updateCellPreviewCharCount()}catch{updateStatus("Content is not valid JSON")}}function toggleCellPreviewWrap(){cellPreviewWrapEnabled=!cellPreviewWrapEnabled;const e=document.getElementById("cellPreviewTextarea"),t=document.getElementById("wrapTextBtn");e.style.whiteSpace=cellPreviewWrapEnabled?"pre-wrap":"pre",e.style.overflowX=cellPreviewWrapEnabled?"hidden":"auto",t.classList.toggle("active",cellPreviewWrapEnabled)}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("cellPreviewTextarea");e&&e.addEventListener("input",updateCellPreviewCharCount)});let rowClickTimer=null;function onRowNumberClick(e,t){e.stopPropagation(),rowClickTimer&&(clearTimeout(rowClickTimer),rowClickTimer=null),selectedCells=[],lastSelectedCell=null,selectedColumns.clear(),updateCellSelectionUI(),e.ctrlKey||e.metaKey?selectedRowIds.has(t)?selectedRowIds.delete(t):selectedRowIds.add(t):selectedRowIds.has(t)?selectedRowIds.delete(t):(selectedRowIds.clear(),selectedRowIds.add(t)),updateRowSelectionUI(),updateToolbarButtons()}function onRowClick(e,t,n){rowClickTimer&&(clearTimeout(rowClickTimer),rowClickTimer=null),rowClickTimer=setTimeout(()=>{rowClickTimer=null,!editingCellInfo&&(e.ctrlKey||e.metaKey?selectedRowIds.has(t)?selectedRowIds.delete(t):selectedRowIds.add(t):(selectedRowIds.clear(),selectedRowIds.add(t)),renderDataGrid(),updateToolbarButtons())},80)}function startColumnResize(e,t){e.stopPropagation(),e.preventDefault(),resizingColumn=t,resizeStartX=e.clientX;const n=document.querySelector(`th[data-column="${t}"]`);resizeStartWidth=n?n.offsetWidth:150,e.target.classList.add("resizing"),document.addEventListener("mousemove",onColumnResize),document.addEventListener("mouseup",stopColumnResize),document.body.style.userSelect="none",document.body.style.cursor="col-resize"}function onColumnResize(e){if(!resizingColumn)return;const t=e.clientX-resizeStartX,n=Math.max(30,resizeStartWidth+t);columnWidths[resizingColumn]=n;const l=tableColumns.findIndex(a=>a.name===resizingColumn);if(l===-1)return;const o=document.querySelector(`th[data-column="${resizingColumn}"]`);o&&(o.style.width=`${n}px`,o.style.minWidth=`${n}px`,o.style.maxWidth=`${n}px`);const s=document.querySelectorAll(`.data-row td:nth-child(${l+2})`);for(const a of s)a.style.width=`${n}px`,a.style.minWidth=`${n}px`,a.style.maxWidth=`${n}px`}function stopColumnResize(){if(!resizingColumn)return;const e=document.querySelector(".resize-handle.resizing");e&&e.classList.remove("resizing"),resizingColumn=null,document.removeEventListener("mousemove",onColumnResize),document.removeEventListener("mouseup",stopColumnResize),document.body.style.userSelect="",document.body.style.cursor="",updateCellOverflowStates()}function onColumnSort(e){sortedColumn===e?sortAscending=!sortAscending:(sortedColumn=e,sortAscending=!0),loadTableData()}function onColumnHeaderClick(e,t){e.stopPropagation();const n=tableColumns.findIndex(a=>a.name===t);if(n===-1)return;selectedRowIds.clear();const l=gridData.length;let o=0;for(const a of selectedCells)a.colIdx===n&&o++;const s=l>0&&o===l;if(e.metaKey||e.ctrlKey)if(s)selectedCells=selectedCells.filter(a=>a.colIdx!==n),selectedColumns.delete(t);else{for(let a=0;a<gridData.length;a++){const r=getRowId(gridData[a],a),u=getCellValue(gridData[a],n);selectedCells.some(c=>c.rowIdx===a&&c.colIdx===n)||selectedCells.push({rowIdx:a,colIdx:n,rowId:r,value:u})}selectedColumns.add(t),gridData.length>0&&(lastSelectedCell={rowIdx:0,colIdx:n,rowId:getRowId(gridData[0],0),value:getCellValue(gridData[0],n)})}else if(s)selectedCells=[],lastSelectedCell=null,selectedColumns.clear();else{selectedCells=[],selectedColumns.clear();for(let a=0;a<gridData.length;a++){const r=getRowId(gridData[a],a),u=getCellValue(gridData[a],n);selectedCells.push({rowIdx:a,colIdx:n,rowId:r,value:u})}selectedColumns.add(t),gridData.length>0&&(lastSelectedCell={rowIdx:0,colIdx:n,rowId:getRowId(gridData[0],0),value:getCellValue(gridData[0],n)})}updateCellSelectionUI(),updateRowSelectionUI(),updateToolbarButtons()}function onFilterChange(){clearTimeout(filterTimer),filterTimer=setTimeout(()=>{filterQuery=document.getElementById("filterInput").value.trim(),currentPageIndex=0,loadTableData()},300)}function onColumnFilterKeydown(e,t){e.key==="Enter"&&(e.preventDefault(),applyColumnFilter(t))}function applyColumnFilter(e){const t=document.querySelector(`.column-filter[data-column="${e}"]`);t&&(columnFilters[e]=t.value.trim(),currentPageIndex=0,loadTableData())}function toggleColumnPin(e,t){e.stopPropagation(),pinnedColumns.has(t)?pinnedColumns.delete(t):pinnedColumns.add(t),renderDataGrid()}function toggleRowPin(e,t){e.stopPropagation(),pinnedRowIds.has(t)?pinnedRowIds.delete(t):pinnedRowIds.add(t),renderDataGrid()}function updatePagination(){document.getElementById("pageIndicator").textContent=`${currentPageIndex+1} / ${totalPageCount}`,document.getElementById("btnFirst").disabled=currentPageIndex===0,document.getElementById("btnPrev").disabled=currentPageIndex===0,document.getElementById("btnNext").disabled=currentPageIndex>=totalPageCount-1,document.getElementById("btnLast").disabled=currentPageIndex>=totalPageCount-1}function goToPage(e){e<0||e>=totalPageCount||(currentPageIndex=e,loadTableData())}function onPageSizeChange(){rowsPerPage=parseInt(document.getElementById("pageSizeSelect").value,10),currentPageIndex=0,loadTableData()}function openAddRowModal(){if(!selectedTable||selectedTableType!=="table")return;const e=document.getElementById("addRowForm");e.innerHTML=tableColumns.map(t=>{const n=t.notnull===1&&!t.isPrimaryKey,l=n?' <span style="color: var(--error-color)">*</span>':"";return`
        <div class="form-field">
            <label>${escapeHtml(t.name)}${l} <span style="opacity:0.5">(${t.type})</span></label>
            <input type="text" data-column="${escapeHtml(t.name)}" data-required="${n}" placeholder="${t.isPrimaryKey?"Auto (Primary Key)":n?"Required":"NULL"}" ${t.isPrimaryKey?"disabled":""}>
        </div>
    `}).join(""),openModal("addRowModal")}async function submitAddRow(){const e=document.querySelectorAll("#addRowForm input[data-column]:not([disabled])"),t=[],n=[],l=[];for(const s of e){const a=s.dataset.column,r=s.value.trim();s.dataset.required==="true"&&(r===""||r.toLowerCase()==="null")?(l.push(a),s.style.borderColor="var(--error-color)"):s.style.borderColor=""}if(l.length>0){updateStatus(`Required fields missing: ${l.join(", ")}`);return}for(const s of e){const a=s.dataset.column,r=s.value.trim();r!==""&&(t.push(escapeIdentifier(a)),r.toLowerCase()==="null"?n.push("NULL"):!isNaN(Number(r))&&r!==""?n.push(r):n.push(`'${r.replace(/'/g,"''")}'`))}let o;t.length===0?o=`INSERT INTO ${escapeIdentifier(selectedTable)} DEFAULT VALUES`:o=`INSERT INTO ${escapeIdentifier(selectedTable)} (${t.join(", ")}) VALUES (${n.join(", ")})`;try{updateStatus("Inserting row..."),await backendApi.exec(o),await backendApi.fireEditEvent({description:`Insert row into ${selectedTable}`,operation:"add",targetTable:selectedTable,queryText:o}),closeModal("addRowModal"),await loadTableData(),updateStatus("Row inserted - Ctrl+S to save")}catch(s){console.error("Insert failed:",s),updateStatus(`Error: ${s.message}`)}}function openDeleteModal(){if(selectedColumns.size>0){const e=Array.from(selectedColumns);document.getElementById("deleteConfirmText").textContent=`Are you sure you want to delete ${e.length} column${e.length>1?"s":""} (${e.join(", ")})? This will permanently remove the column${e.length>1?"s":""} and all their data.`}else if(selectedRowIds.size>0)document.getElementById("deleteConfirmText").textContent=`Are you sure you want to delete ${selectedRowIds.size} row${selectedRowIds.size>1?"s":""}?`;else return;openModal("deleteModal")}async function submitDelete(){selectedColumns.size>0?await submitDeleteColumns():selectedRowIds.size>0&&await submitDeleteRows()}async function submitDeleteRows(){if(selectedRowIds.size===0)return;const e=Array.from(selectedRowIds),t=e.map(l=>validateRowId(l)),n=`DELETE FROM ${escapeIdentifier(selectedTable)} WHERE rowid IN (${t.join(", ")})`;try{updateStatus("Deleting rows..."),await backendApi.exec(n),await backendApi.fireEditEvent({description:`Delete ${e.length} row${e.length>1?"s":""} from ${selectedTable}`,operation:"remove",targetTable:selectedTable,affectedRecords:e,queryText:n}),closeModal("deleteModal"),selectedRowIds.clear(),await loadTableData(),updateToolbarButtons(),updateStatus(`Deleted ${e.length} row${e.length>1?"s":""} - Ctrl+S to save`)}catch(l){console.error("Delete rows failed:",l),updateStatus(`Error: ${l.message}`)}}async function submitDeleteColumns(){if(selectedColumns.size===0)return;const e=Array.from(selectedColumns);try{updateStatus("Deleting columns...");for(const t of e){const n=`ALTER TABLE ${escapeIdentifier(selectedTable)} DROP COLUMN ${escapeIdentifier(t)}`;await backendApi.exec(n)}await backendApi.fireEditEvent({description:`Delete column${e.length>1?"s":""} ${e.join(", ")} from ${selectedTable}`,operation:"drop_column",targetTable:selectedTable,affectedColumns:e}),closeModal("deleteModal"),selectedColumns.clear(),selectedCells=[],lastSelectedCell=null,await refreshSchema(),await loadTableColumns(),await loadTableData(),updateToolbarButtons(),updateStatus(`Deleted ${e.length} column${e.length>1?"s":""} - Ctrl+S to save`)}catch(t){console.error("Delete columns failed:",t);let n=t.message||String(t);(n.includes("no such column")||n.includes("cannot drop"))&&(n="Cannot delete this column. It may be a primary key or referenced by other constraints."),updateStatus(`Error: ${n}`)}}async function exportCurrentTable(){selectedTable&&await backendApi.exportTable({table:selectedTable},tableColumns.map(e=>e.name))}async function reloadFromDisk(){if(isDbConnected)try{updateStatus("Reloading..."),await backendApi.refreshFile(),await refreshSchema(),selectedTable&&(await loadTableColumns(),await loadTableData()),updateStatus("Reloaded")}catch(e){console.error("Reload failed:",e),updateStatus(`Reload failed: ${e.message}`)}}function openModal(e){document.getElementById(e).classList.remove("hidden")}function closeModal(e){document.getElementById(e).classList.add("hidden")}function updateStatus(e){document.getElementById("statusText").textContent=e}function updateToolbarButtons(){const e=selectedTable&&selectedTableType==="table",t=selectedRowIds.size>0,n=selectedColumns.size>0;document.getElementById("btnAddRow").disabled=!e,document.getElementById("btnAddColumn").disabled=!e,document.getElementById("btnDeleteRows").disabled=!e||!t&&!n,document.getElementById("btnExport").disabled=!selectedTable}function showLoading(){document.getElementById("gridContainer").innerHTML=`
        <div class="loading-view">
            <div class="loading-spinner"></div>
            <span>Loading...</span>
        </div>
    `}function showEmptyState(){document.getElementById("gridContainer").innerHTML=`
        <div class="empty-view">
            <span class="empty-icon codicon codicon-database"></span>
            <span class="empty-title">Select a table</span>
            <span class="empty-desc">Choose a table from the sidebar to view data</span>
        </div>
    `}function showErrorState(e){document.getElementById("gridContainer").innerHTML=`
        <div class="empty-view">
            <span class="empty-icon codicon codicon-error" style="color: var(--error-color)"></span>
            <span class="empty-title">Error</span>
            <span class="empty-desc">${escapeHtml(e)}</span>
        </div>
    `}function validateRowId(e){const t=Number(e);if(!Number.isFinite(t))throw new Error(`Invalid rowid: ${e}`);return t}function escapeIdentifier(e){return e==null?'""':`"${String(e).replace(/"/g,'""')}"`}function escapeHtml(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let columnDefCounter=0;function openCreateTableModal(){document.getElementById("newTableName").value="",document.getElementById("columnDefinitions").innerHTML="",columnDefCounter=0,addColumnDefinition(!0),openModal("createTableModal")}function addColumnDefinition(e=!1){const t=document.getElementById("columnDefinitions"),n=++columnDefCounter,l=`
        <div class="column-def-row" id="colDef_${n}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
            <input type="text" placeholder="Column name" class="col-name" style="flex: 2;" value="${e?"id":""}">
            <select class="col-type" style="flex: 1;">
                <option value="INTEGER" ${e?"selected":""}>INTEGER</option>
                <option value="TEXT" ${e?"":"selected"}>TEXT</option>
                <option value="REAL">REAL</option>
                <option value="BLOB">BLOB</option>
                <option value="NUMERIC">NUMERIC</option>
            </select>
            <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" class="col-pk" ${e?"checked":""}> PK
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" class="col-nn"> NN
            </label>
            <button class="icon-button" onclick="removeColumnDefinition(${n})" title="Remove" ${e?"disabled":""}>
                <span class="codicon codicon-close"></span>
            </button>
        </div>
    `;t.insertAdjacentHTML("beforeend",l)}function removeColumnDefinition(e){const t=document.getElementById(`colDef_${e}`);t&&t.remove()}async function submitCreateTable(){const e=document.getElementById("newTableName").value.trim();if(!e){updateStatus("Error: Table name is required");return}if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)){updateStatus("Error: Table name must start with a letter or underscore and contain only letters, numbers, and underscores");return}const t=[],n=document.querySelectorAll(".column-def-row");for(const o of n){const s=o.querySelector(".col-name").value.trim(),a=o.querySelector(".col-type").value,r=o.querySelector(".col-pk").checked,u=o.querySelector(".col-nn").checked;if(!s)continue;let d=`${escapeIdentifier(s)} ${a}`;r&&(d+=" PRIMARY KEY"),u&&!r&&(d+=" NOT NULL"),t.push(d)}if(t.length===0){updateStatus("Error: At least one column is required");return}const l=`CREATE TABLE ${escapeIdentifier(e)} (${t.join(", ")})`;try{updateStatus("Creating table..."),await backendApi.exec(l),await backendApi.fireEditEvent({description:`Create table ${e}`,operation:"add",targetTable:e,queryText:l}),closeModal("createTableModal"),await refreshSchema(),updateStatus(`Table "${e}" created - Ctrl+S to save`)}catch(o){console.error("Create table failed:",o),updateStatus(`Error: ${o.message}`)}}function openAddColumnModal(){!selectedTable||selectedTableType!=="table"||(document.getElementById("newColumnName").value="",document.getElementById("newColumnType").value="TEXT",document.getElementById("newColumnDefault").value="",openModal("addColumnModal"))}async function submitAddColumn(){const e=document.getElementById("newColumnName").value.trim(),t=document.getElementById("newColumnType").value,n=document.getElementById("newColumnDefault").value.trim();if(!e){updateStatus("Error: Column name is required");return}if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)){updateStatus("Error: Column name must start with a letter or underscore");return}let l=`ALTER TABLE ${escapeIdentifier(selectedTable)} ADD COLUMN ${escapeIdentifier(e)} ${t}`;n&&(n.toLowerCase()==="null"?l+=" DEFAULT NULL":isNaN(Number(n))?l+=` DEFAULT '${n.replace(/'/g,"''")}'`:l+=` DEFAULT ${n}`);try{updateStatus("Adding column..."),await backendApi.exec(l),await backendApi.fireEditEvent({description:`Add column ${e} to ${selectedTable}`,operation:"modify",targetTable:selectedTable,queryText:l}),closeModal("addColumnModal"),await loadTableColumns(),await loadTableData(),updateStatus(`Column "${e}" added - Ctrl+S to save`)}catch(o){console.error("Add column failed:",o),updateStatus(`Error: ${o.message}`)}}(function(){const t=document.getElementById("sidebarPanel"),n=document.getElementById("resizeHandle");let l=!1;n.addEventListener("mousedown",o=>{l=!0,document.body.style.cursor="col-resize",o.preventDefault()}),document.addEventListener("mousemove",o=>{if(!l)return;const s=Math.max(150,Math.min(400,o.clientX));t.style.width=s+"px"}),document.addEventListener("mouseup",()=>{l&&(l=!1,document.body.style.cursor="")})})(),document.addEventListener("keydown",async e=>{if((e.metaKey||e.ctrlKey)&&e.key==="c"){if(editingCellInfo||document.activeElement.tagName==="INPUT")return;selectedCells.length>0?(e.preventDefault(),await copyCellsToClipboard()):selectedRowIds.size>0&&gridData.length>0&&(e.preventDefault(),await copySelectedRowsToClipboard())}if((e.metaKey||e.ctrlKey)&&e.key==="a"){if(editingCellInfo||document.activeElement.tagName==="INPUT")return;selectedTable&&gridData.length>0&&(e.preventDefault(),selectAllRows())}if((e.metaKey||e.ctrlKey)&&(e.key==="Delete"||e.key==="Backspace")){if(editingCellInfo||document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")return;selectedTable&&selectedTableType==="table"&&selectedCells.length>0&&(e.preventDefault(),await clearSelectedCellValues())}});async function copyCellsToClipboard(){if(selectedCells.length!==0)try{let e;if(selectedCells.length===1){const n=selectedCells[0].value;n==null?e="":n instanceof Uint8Array?e="[BLOB]":e=String(n)}else{const n=[...new Set(selectedCells.map(a=>a.rowIdx))].sort((a,r)=>a-r),l=[...new Set(selectedCells.map(a=>a.colIdx))].sort((a,r)=>a-r),o=new Map;for(const a of selectedCells)o.set(`${a.rowIdx},${a.colIdx}`,a.value);const s=[];for(const a of n){const r=[];for(const u of l){const d=`${a},${u}`;if(o.has(d)){const c=o.get(d);c==null?r.push(""):c instanceof Uint8Array?r.push("[BLOB]"):r.push(String(c))}else r.push("")}s.push(r.join("	"))}e=s.join(`
`)}await navigator.clipboard.writeText(e);const t=selectedCells.length;updateStatus(`Copied ${t} cell${t>1?"s":""} to clipboard`)}catch(e){console.error("Copy failed:",e),updateStatus("Copy failed: "+e.message)}}async function copySelectedRowsToClipboard(){if(!(selectedRowIds.size===0||gridData.length===0))try{const e=tableColumns.map(l=>l.name).join("	"),t=[];for(let l=0;l<gridData.length;l++){const o=gridData[l],s=getRowId(o,l);if(selectedRowIds.has(s)){const a=[];for(let r=0;r<tableColumns.length;r++){const u=getCellValue(o,r);u===null?a.push(""):u instanceof Uint8Array?a.push("[BLOB]"):a.push(String(u))}t.push(a.join("	"))}}const n=[e,...t].join(`
`);await navigator.clipboard.writeText(n),updateStatus(`Copied ${t.length} row${t.length>1?"s":""} to clipboard`)}catch(e){console.error("Copy failed:",e),updateStatus("Copy failed: "+e.message)}}async function clearSelectedCellValues(){if(selectedCells.length!==0){if(selectedTableType!=="table"){updateStatus("Views are read-only");return}try{updateStatus("Clearing cells...");const e=[];for(const t of selectedCells){const n=tableColumns[t.colIdx];if(!n)continue;const l=n.notnull===1,o=l?"":null,s=l?"''":"NULL";e.push({rowId:t.rowId,rowIdx:t.rowIdx,colIdx:t.colIdx,columnName:n.name,originalValue:t.value,newValue:o,sql:`UPDATE ${escapeIdentifier(selectedTable)} SET ${escapeIdentifier(n.name)} = ${s} WHERE rowid = ${validateRowId(t.rowId)}`})}for(const t of e)await backendApi.exec(t.sql);await backendApi.fireEditEvent({label:`Clear ${e.length} cell${e.length>1?"s":""}`,description:`Clear ${e.length} cell${e.length>1?"s":""} in ${selectedTable}`,modificationType:"cell_clear",targetTable:selectedTable,affectedCells:e.map(t=>({rowId:t.rowId,columnName:t.columnName,previousValue:t.originalValue,newValue:t.newValue}))});for(const t of e)gridData[t.rowIdx][t.colIdx+getRowDataOffset()]=t.newValue;selectedCells=[],lastSelectedCell=null,selectedColumns.clear(),await loadTableData(),updateToolbarButtons(),updateStatus(`Cleared ${e.length} cell${e.length>1?"s":""} - Ctrl+S to save`)}catch(e){console.error("Clear cells failed:",e);let t=e.message||String(e);t.includes("NOT NULL constraint failed")&&(t="Cannot clear: one or more columns require a value (NOT NULL constraint)"),updateStatus(`Clear failed: ${t}`)}}}function selectAllRows(){if(gridData.length===0)return;if(selectedCells=[],lastSelectedCell=null,selectedColumns.clear(),updateCellSelectionUI(),gridData.every((t,n)=>selectedRowIds.has(getRowId(t,n))))selectedRowIds.clear();else for(let t=0;t<gridData.length;t++)selectedRowIds.add(getRowId(gridData[t],t));updateRowSelectionUI(),updateToolbarButtons()}function updateRowSelectionUI(){const e=document.querySelectorAll(".data-row");for(const t of e){const n=parseInt(t.dataset.rowid,10);selectedRowIds.has(n)?t.classList.add("selected"):t.classList.remove("selected")}}function onSelectAllClick(e){e.stopPropagation(),selectAllRows()}initializeApp();

    </script>
    <!--BODY-->
</body>
</html>
