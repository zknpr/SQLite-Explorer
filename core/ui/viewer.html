<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Explorer</title>
    <!--HEAD-->
    <style>
:root{--bg-primary: var(--vscode-editor-background, #1e1e1e);--bg-secondary: var(--vscode-sideBar-background, #252526);--bg-tertiary: var(--vscode-input-background, #3c3c3c);--bg-stripe: rgba(255, 255, 255, .02);--text-primary: var(--vscode-editor-foreground, #cccccc);--text-secondary: var(--vscode-descriptionForeground, #888888);--border-color: var(--vscode-panel-border, #454545);--accent-color: var(--vscode-focusBorder, #007acc);--hover-bg: var(--vscode-list-hoverBackground, #2a2d2e);--active-bg: var(--vscode-list-activeSelectionBackground, #094771);--active-text: var(--vscode-list-activeSelectionForeground, #ffffff);--error-color: var(--vscode-errorForeground, #f48771);--success-color: var(--vscode-terminal-ansiGreen, #89d185);--sidebar-width: 220px;--toolbar-height: 36px;--footer-height: 28px;--row-height: 26px;--header-height: 52px;--row-num-width: 50px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--vscode-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);font-size:var(--vscode-font-size, 13px);background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;display:flex}.app-container{display:flex;width:100%;height:100%}.sidebar-panel{width:var(--sidebar-width);min-width:150px;max-width:400px;background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;position:relative}.main-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}.sidebar-header{padding:8px 12px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);flex-shrink:0}.sidebar-scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0}.sidebar-actions{display:flex;gap:4px}.icon-button{background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:4px;border-radius:3px;display:flex;align-items:center;justify-content:center}.icon-button:hover{background:var(--hover-bg);color:var(--text-primary)}.section-title{padding:6px 12px;font-size:11px;font-weight:600;color:var(--text-secondary);display:flex;align-items:center;cursor:pointer;user-select:none}.section-title:hover{background:var(--hover-bg)}.section-title .arrow{margin-right:4px;transition:transform .15s}.section-title.collapsed .arrow{transform:rotate(-90deg)}.section-title .badge{margin-left:auto;background:var(--bg-tertiary);padding:1px 6px;border-radius:10px;font-size:10px}.item-list{list-style:none}.item-list.hidden{display:none}.list-item{padding:4px 12px 4px 24px;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.list-item:hover{background:var(--hover-bg)}.list-item.selected{background:var(--active-bg);color:var(--active-text)}.list-item .item-icon{opacity:.7;flex-shrink:0}.list-item .item-name{overflow:hidden;text-overflow:ellipsis}.resize-handle{position:absolute;right:0;top:0;bottom:0;width:4px;cursor:col-resize}.resize-handle:hover{background:var(--accent-color)}.toolbar-panel{height:var(--toolbar-height);background:var(--bg-secondary);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 8px;gap:8px}.toolbar-left{display:flex;align-items:center;gap:8px}.toolbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}.current-table{display:flex;align-items:center;gap:6px;font-weight:500}.toolbar-button{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px}.toolbar-button:hover{background:var(--hover-bg)}.toolbar-button:disabled{opacity:.5;cursor:not-allowed}.filter-input{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 8px;border-radius:3px;font-size:12px;width:200px}.filter-input:focus{outline:none;border-color:var(--accent-color)}.grid-container{flex:1;overflow:auto;position:relative}.data-grid{border-collapse:separate;border-spacing:0;table-layout:fixed}.grid-header{z-index:10;background:var(--bg-secondary)}.grid-header tr{height:var(--header-height);max-height:var(--header-height)}.header-cell{padding:4px 8px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;color:var(--text-secondary);border-bottom:1px solid var(--border-color);user-select:none;white-space:nowrap;overflow:visible;position:sticky;top:0;z-index:10;background:var(--bg-secondary);box-sizing:border-box;height:var(--header-height);max-height:var(--header-height);vertical-align:top}.header-content{display:flex;flex-direction:column;height:100%;gap:2px}.header-top{display:flex;align-items:center;gap:4px;height:22px;cursor:pointer;overflow:hidden}.header-bottom{flex:1;display:flex;align-items:center}.header-cell:hover{background:linear-gradient(var(--hover-bg),var(--hover-bg)),var(--bg-secondary)}.header-cell .resize-handle{position:absolute;right:-4px;top:0;height:100%;width:10px;cursor:col-resize;background:transparent;z-index:15}.header-cell .resize-handle:hover,.header-cell .resize-handle.resizing{background:var(--accent-color);background-clip:padding-box;border-left:3px solid transparent;border-right:3px solid transparent}.header-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}.sort-indicator{font-size:10px;margin-left:4px;color:var(--text-secondary)}.key-icon{font-size:12px;margin-right:4px;color:var(--vscode-editorWarning-foreground, #cca700);flex-shrink:0}.header-cell.row-number-header{text-align:center;cursor:pointer;box-shadow:1px 0 0 0 var(--border-color)}.header-cell.row-number-header:hover{background:var(--hover-bg)}.column-filter{flex:1;min-width:0;padding:2px 6px;font-size:11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:3px 0 0 3px;color:var(--text-primary);box-sizing:border-box;text-transform:none;font-weight:400}.column-filter:focus{outline:none;border-color:var(--accent-color)}.column-filter::placeholder{color:var(--text-secondary);opacity:.7}.filter-apply-btn{padding:2px 6px;font-size:11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-left:none;border-radius:0 3px 3px 0;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}.filter-apply-btn:hover{background:var(--hover-bg);color:var(--text-primary)}.filter-apply-btn .codicon{font-size:12px}.header-cell.pinned,.data-cell.pinned{z-index:5;background-color:var(--bg-secondary)!important;border-right:1px solid var(--border-color);border-left:1px solid var(--border-color);box-shadow:none}.header-cell.pinned{z-index:12;background-color:var(--bg-secondary)!important}.data-row.selected .data-cell.pinned,.header-cell.pinned.column-selected,.data-cell.pinned.cell-selected{background:linear-gradient(var(--active-bg),var(--active-bg)),var(--bg-secondary)!important}.data-row.pinned{position:sticky;z-index:6}.data-row.pinned td{background-color:var(--bg-secondary)!important;box-shadow:0 1px 0 0 var(--border-color)}.data-row.pinned.selected td{background:linear-gradient(var(--active-bg),var(--active-bg)),var(--bg-secondary)!important}.data-row.pinned td.pinned{background-color:var(--bg-secondary)!important;box-shadow:1px 0 0 0 var(--border-color),0 1px 0 0 var(--border-color);z-index:15!important}.data-row.pinned.selected td.pinned{background:linear-gradient(var(--active-bg),var(--active-bg)),var(--bg-secondary)!important}.pin-icon{cursor:pointer;opacity:0;margin-left:4px;font-size:12px;vertical-align:middle}.header-cell:hover .pin-icon,.header-cell:hover .select-column-icon,.data-cell.row-number:hover .pin-icon,.pin-icon.pinned{opacity:.5}.pin-icon:hover,.select-column-icon:hover{opacity:1!important}.pin-icon.pinned{opacity:.8}.select-column-icon{opacity:0;cursor:pointer;margin-right:4px;font-size:12px;vertical-align:middle}.data-row{height:var(--row-height);max-height:var(--row-height);background:var(--bg-primary)}.data-row td{background:transparent}.data-row:nth-child(2n){background:var(--bg-stripe)}.data-row:hover{background:var(--hover-bg)}.data-row.selected{background:var(--active-bg)}.data-cell{position:relative;padding:4px 8px;border-bottom:1px solid var(--border-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-sizing:border-box;height:var(--row-height);max-height:var(--row-height)}.data-cell.row-number{background:var(--bg-secondary);color:var(--text-secondary);text-align:center;font-size:.85em;user-select:none;box-shadow:1px 0 0 0 var(--border-color)}.data-cell.null-value{color:var(--text-secondary);font-style:italic}.data-cell.cell-selected{background:var(--active-bg)}.header-cell.column-selected{background:linear-gradient(var(--active-bg),var(--active-bg)),var(--bg-secondary)!important}.header-cell.column-selected .header-text{color:var(--active-text)}.data-cell.editing{padding:0}.cell-input{position:absolute;top:0;left:0;display:block;width:100%;height:100%;margin:0;padding:2px 6px;border:2px solid var(--accent-color);background:var(--bg-tertiary);color:var(--text-primary);font-family:inherit;font-size:inherit;outline:none;resize:none;box-sizing:border-box}.empty-view{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:12px}.empty-view .empty-icon{font-size:48px;opacity:.5}.empty-view .empty-title{font-size:16px;font-weight:500}.empty-view .empty-desc{font-size:13px}.loading-view{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px}.loading-spinner{width:32px;height:32px;border:3px solid var(--border-color);border-top-color:var(--accent-color);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.footer-panel{height:var(--footer-height);background:var(--bg-secondary);border-top:1px solid var(--border-color);display:flex;align-items:center;padding:0 12px;font-size:12px}.footer-left{display:flex;align-items:center;gap:12px}.footer-right{margin-left:auto;display:flex;align-items:center;gap:12px}.page-selector{display:flex;align-items:center;gap:4px}.page-selector select{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:2px 6px;border-radius:3px;font-size:11px}.pagination-controls{display:flex;align-items:center;gap:4px}.pagination-controls button{background:none;border:none;color:var(--text-primary);cursor:pointer;padding:2px 6px;border-radius:3px}.pagination-controls button:hover:not(:disabled){background:var(--hover-bg)}.pagination-controls button:disabled{opacity:.3;cursor:not-allowed}.modal-overlay{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-overlay.hidden{display:none}.modal-dialog{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;min-width:400px;max-width:600px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}.modal-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.modal-title{font-weight:600;font-size:14px}.modal-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:18px;padding:4px}.modal-close:hover{color:var(--text-primary)}.modal-body{padding:16px;overflow-y:auto}.modal-footer{padding:12px 16px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:8px}.form-field{margin-bottom:12px}.form-field label{display:block;margin-bottom:4px;font-size:12px;color:var(--text-secondary)}.form-field input[type=checkbox]{width:auto;margin-right:0}.form-field input:not([type=checkbox]),.form-field select{width:100%;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:3px;color:var(--text-primary);font-size:13px}.form-field input:focus,.form-field select:focus{outline:none;border-color:var(--accent-color)}.btn-primary{background:var(--accent-color);border:none;color:#fff;padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.btn-primary:hover{opacity:.9}.btn-secondary{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.btn-secondary:hover{background:var(--hover-bg)}.btn-danger{background:var(--error-color);border:none;color:#fff;padding:6px 14px;border-radius:3px;cursor:pointer;font-size:13px}.cell-preview-modal{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1100}.cell-preview-modal.hidden{display:none}.cell-preview-dialog{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;width:600px;max-width:90vw;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 8px 32px #0000004d}.cell-preview-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:var(--bg-tertiary)}.cell-preview-title{font-weight:600;font-size:13px;color:var(--text-primary);display:flex;align-items:center;gap:8px}.cell-preview-column-name{color:var(--accent-color);font-family:monospace}.cell-preview-type-badge{font-size:10px;padding:2px 6px;background:var(--bg-secondary);border-radius:3px;color:var(--text-secondary);text-transform:uppercase}.cell-preview-close{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:3px}.cell-preview-close:hover{background:var(--hover-bg);color:var(--text-primary)}.cell-preview-body{flex:1;padding:16px;overflow:auto;min-height:200px;max-height:60vh}.cell-preview-textarea{width:100%;height:100%;min-height:180px;padding:12px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:4px;color:var(--text-primary);font-family:monospace;font-size:13px;line-height:1.5;resize:vertical;box-sizing:border-box}.cell-preview-textarea:focus{outline:none;border-color:var(--accent-color)}.cell-preview-textarea.readonly{background:var(--bg-secondary);cursor:default}.cell-preview-toolbar{padding:8px 16px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}.cell-preview-toolbar-btn{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:4px 10px;border-radius:3px;cursor:pointer;font-size:11px;display:flex;align-items:center;gap:4px}.cell-preview-toolbar-btn:hover{background:var(--hover-bg)}.cell-preview-toolbar-btn:disabled{opacity:.5;cursor:not-allowed}.cell-preview-toolbar-btn.active{background:var(--accent-color);border-color:var(--accent-color);color:#fff}.cell-preview-footer{padding:12px 16px;border-top:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:var(--bg-tertiary)}.cell-preview-info{font-size:11px;color:var(--text-secondary)}.cell-preview-actions{display:flex;gap:8px}.data-cell .cell-text{display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.data-cell .expand-icon{display:none;position:absolute;right:4px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--text-secondary);background:var(--bg-secondary);padding:2px 4px;border-radius:2px;cursor:pointer;z-index:1}.data-cell .expand-icon:hover{color:var(--text-primary);background:var(--hover-bg)}.data-cell.has-overflow:hover .expand-icon{display:inline-block}.data-cell.has-overflow{cursor:pointer}.data-cell.has-overflow:hover{background:var(--hover-bg)}.data-cell.drag-over{outline:2px dashed var(--accent-color);background-color:var(--hover-bg);outline-offset:-2px}

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Panel -->
        <div class="sidebar-panel" id="sidebarPanel">
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-actions">
                    <button class="icon-button" onclick="reloadFromDisk()" title="Reload">
                        <span class="codicon codicon-refresh"></span>
                    </button>
                </div>
            </div>

            <div class="sidebar-scroll-area">
                <!-- Tables Section -->
                <div class="section-title" data-section="tables" onclick="toggleSection('tables')">
                    <span class="arrow">▼</span>
                    <span>Tables</span>
                    <span class="badge" id="tablesBadge">0</span>
                    <button class="icon-button" onclick="event.stopPropagation(); openCreateTableModal()" title="Create Table" style="margin-left: auto;">
                        <span class="codicon codicon-add"></span>
                    </button>
                </div>
                <ul class="item-list" id="tablesList"></ul>

                <!-- Views Section -->
                <div class="section-title collapsed" data-section="views" onclick="toggleSection('views')">
                    <span class="arrow">▼</span>
                    <span>Views</span>
                    <span class="badge" id="viewsBadge">0</span>
                </div>
                <ul class="item-list hidden" id="viewsList"></ul>

                <!-- Indexes Section -->
                <div class="section-title collapsed" data-section="indexes" onclick="toggleSection('indexes')">
                    <span class="arrow">▼</span>
                    <span>Indexes</span>
                    <span class="badge" id="indexesBadge">0</span>
                </div>
                <ul class="item-list hidden" id="indexesList"></ul>

                <!-- Batch Update Section -->
                <div class="section-title hidden" id="batchUpdateSectionTitle" data-section="batchUpdate" onclick="toggleSection('batchUpdate')">
                    <span class="arrow">▼</span>
                    <span>Batch Update</span>
                    <span class="badge" id="batchUpdateCount">0</span>
                </div>
                <div class="item-list hidden" id="batchUpdateList">
                    <div style="padding: 12px;">
                        <button class="btn-primary" onclick="applyBatchUpdate()" style="width:100%; margin-bottom:12px">Apply Changes</button>
                        <div id="batchUpdateFields"></div>
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="section-title" onclick="openSettingsModal()" style="border-top: 1px solid var(--border-color); flex-shrink: 0;">
                <span class="codicon codicon-settings" style="margin-right: 6px;"></span>
                <span>Configuration</span>
            </div>

            <div class="resize-handle" id="resizeHandle"></div>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Toolbar -->
            <div class="toolbar-panel">
                <div class="toolbar-left">
                    <div class="current-table" id="currentTable">
                        <span class="codicon codicon-table"></span>
                        <span id="tableNameLabel">No table selected</span>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button class="toolbar-button" id="btnAddRow" onclick="openAddRowModal()" disabled>
                        <span class="codicon codicon-add"></span> Add Row
                    </button>
                    <button class="toolbar-button" id="btnAddColumn" onclick="openAddColumnModal()" disabled>
                        <span class="codicon codicon-insert"></span> Add Column
                    </button>
                    <button class="toolbar-button" id="btnDeleteRows" onclick="openDeleteModal()" disabled>
                        <span class="codicon codicon-trash"></span> Delete
                    </button>
                    <button class="toolbar-button" id="btnExport" onclick="openExportModal()" disabled>
                        <span class="codicon codicon-export"></span> Export
                    </button>
                    <input type="text" class="filter-input" id="filterInput" placeholder="Filter..." onkeyup="onFilterChange()">
                </div>
            </div>

            <!-- Grid Container -->
            <div class="grid-container" id="gridContainer">
                <div class="loading-view" id="loadingView">
                    <div class="loading-spinner"></div>
                    <span>Connecting to database...</span>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer-panel">
                <div class="footer-left">
                    <span id="statusText">Ready</span>
                </div>
                <div class="footer-right">
                    <div class="page-selector">
                        <span>Rows:</span>
                        <select id="pageSizeSelect" onchange="onPageSizeChange()">
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="500" selected>500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="page-selector">
                        <span>Date Format:</span>
                        <select id="dateFormatSelect" onchange="onDateFormatChange()">
                            <option value="raw">Raw</option>
                            <option value="local">Local</option>
                            <option value="iso">ISO</option>
                            <option value="relative">Relative</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <button id="btnFirst" onclick="goToPage(0)" disabled>⏮</button>
                        <button id="btnPrev" onclick="goToPage(currentPageIndex - 1)" disabled>◀</button>
                        <span id="pageIndicator">0 / 0</span>
                        <button id="btnNext" onclick="goToPage(currentPageIndex + 1)" disabled>▶</button>
                        <button id="btnLast" onclick="goToPage(totalPageCount - 1)" disabled>⏭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Row Modal -->
    <div class="modal-overlay hidden" id="addRowModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Add New Row</span>
                <button class="modal-close" onclick="closeModal('addRowModal')">&times;</button>
            </div>
            <div class="modal-body" id="addRowForm"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addRowModal')">Cancel</button>
                <button class="btn-primary" onclick="submitAddRow()">Add Row</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay hidden" id="deleteModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Confirm Delete</span>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">Are you sure you want to delete the selected rows?</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn-danger" onclick="submitDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Create Table Modal -->
    <div class="modal-overlay hidden" id="createTableModal">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-header">
                <span class="modal-title">Create New Table</span>
                <button class="modal-close" onclick="closeModal('createTableModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Table Name</label>
                    <input type="text" id="newTableName" placeholder="my_table">
                </div>
                <div class="form-field">
                    <label>Columns</label>
                    <div id="columnDefinitions"></div>
                    <button class="btn-secondary" onclick="addColumnDefinition()" style="margin-top: 8px;">+ Add Column</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('createTableModal')">Cancel</button>
                <button class="btn-primary" onclick="submitCreateTable()">Create Table</button>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal-overlay hidden" id="addColumnModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Add Column</span>
                <button class="modal-close" onclick="closeModal('addColumnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Column Name</label>
                    <input type="text" id="newColumnName" placeholder="column_name">
                </div>
                <div class="form-field">
                    <label>Type</label>
                    <select id="newColumnType">
                        <option value="TEXT">TEXT</option>
                        <option value="INTEGER">INTEGER</option>
                        <option value="REAL">REAL</option>
                        <option value="BLOB">BLOB</option>
                        <option value="NUMERIC">NUMERIC</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>Default Value (optional)</label>
                    <input type="text" id="newColumnDefault" placeholder="NULL">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addColumnModal')">Cancel</button>
                <button class="btn-primary" onclick="submitAddColumn()">Add Column</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay hidden" id="exportModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-title">Export Table</span>
                <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-field">
                    <label>Format</label>
                    <select id="exportFormat" onchange="onExportFormatChange()">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="sql">SQL INSERT</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>Columns</label>
                    <div id="exportColumns" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 8px; border-radius: 3px; background: var(--bg-primary);">
                        <!-- Columns populated by JS -->
                    </div>
                </div>
                <div class="form-field">
                    <label>Options</label>
                    <div id="exportOptions">
                        <!-- Options populated by JS based on format -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('exportModal')">Cancel</button>
                <button class="btn-primary" onclick="submitExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settingsModal">
        <div class="modal-dialog" style="width: 600px;">
            <div class="modal-header">
                <span class="modal-title">Configuration</span>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body" id="pragmaSettingsContainer">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal('settingsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Cell Preview/Edit Modal - Floating window for viewing and editing large cell values -->
    <div class="cell-preview-modal hidden" id="cellPreviewModal">
        <div class="cell-preview-dialog">
            <div class="cell-preview-header">
                <div class="cell-preview-title">
                    <span>Column:</span>
                    <span class="cell-preview-column-name" id="cellPreviewColumnName"></span>
                    <span class="cell-preview-type-badge" id="cellPreviewTypeBadge"></span>
                </div>
                <button class="cell-preview-close" onclick="closeCellPreview()">&times;</button>
            </div>
            <div class="cell-preview-toolbar">
                <button class="cell-preview-toolbar-btn" id="formatJsonBtn" onclick="formatCellPreviewJson()" title="Format as JSON">
                    <span class="codicon codicon-json"></span> Format JSON
                </button>
                <button class="cell-preview-toolbar-btn" id="compactJsonBtn" onclick="compactCellPreviewJson()" title="Compact JSON">
                    <span class="codicon codicon-fold"></span> Compact
                </button>
                <button class="cell-preview-toolbar-btn" id="wrapTextBtn" onclick="toggleCellPreviewWrap()" title="Toggle word wrap">
                    <span class="codicon codicon-word-wrap"></span> Wrap
                </button>
                <div style="flex: 1"></div>
                <button class="cell-preview-toolbar-btn" id="openInVsCodeBtn" onclick="openCellInVsCode()" title="Edit in VS Code editor">
                    <span class="codicon codicon-code"></span> Edit in VS Code
                </button>
            </div>
            <div class="cell-preview-body">
                <textarea class="cell-preview-textarea" id="cellPreviewTextarea" spellcheck="false"></textarea>
            </div>
            <div class="cell-preview-footer">
                <div class="cell-preview-info">
                    <span id="cellPreviewCharCount">0 characters</span>
                    <span id="cellPreviewReadonlyBadge" style="display:none;margin-left:8px;color:var(--warning-color);">Read-only (View)</span>
                </div>
                <div class="cell-preview-actions">
                    <button class="btn-secondary" onclick="closeCellPreview()">Cancel</button>
                    <button class="btn-primary" id="cellPreviewSaveBtn" onclick="saveCellPreview()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
"use strict";(()=>{var e={isDbConnected:!1,selectedTable:null,selectedTableType:"table",currentPageIndex:0,rowsPerPage:500,totalRecordCount:0,totalPageCount:1,tableColumns:[],sortedColumn:null,sortAscending:!0,filterQuery:"",filterTimer:null,selectedRowIds:new Set,gridData:[],editingCellInfo:null,activeCellInput:null,isSavingCell:!1,isLoadingData:!1,lastDoubleClickTime:0,isTransitioningEdit:!1,transitionLockTimeout:null,selectedCells:[],lastSelectedCell:null,columnWidths:{},resizingColumn:null,resizeStartX:0,resizeStartWidth:0,columnFilters:{},pinnedColumns:new Set,pinnedRowIds:new Set,cellPreviewInfo:null,cellPreviewWrapEnabled:!0,selectedColumns:new Set,scrollPosition:{top:0,left:0},schemaCache:{tables:[],views:[],indexes:[]},dateFormat:"raw",cellEditBehavior:"inline"};var H=typeof acquireVsCodeApi<"u"?acquireVsCodeApi():null,zt=0,Q=new Map;function C(t,l){return new Promise((n,o)=>{let a=`rpc_${++zt}_${Date.now()}`,i=setTimeout(()=>{Q.has(a)&&(Q.delete(a),o(new Error(`RPC timeout: ${t}`)))},3e4);Q.set(a,{resolve:n,reject:o,timeoutId:i}),H?H.postMessage({channel:"rpc",content:{kind:"invoke",messageId:a,targetMethod:t,payload:l}}):console.warn("VS Code API not available")})}function Oe(t){if(!t||t.kind!=="response")return;let l=Q.get(t.messageId);l&&(clearTimeout(l.timeoutId),Q.delete(t.messageId),t.success?l.resolve(t.data):l.reject(new Error(t.errorMessage||"RPC failed")))}function We(t,l){H&&H.postMessage({kind:"result",correlationId:t,payload:l})}function Ce(t,l){H&&H.postMessage({kind:"result",correlationId:t,errorText:l})}var f={initialize:()=>C("initialize",[]),exportDb:t=>C("exportDb",[t]),refreshFile:()=>C("refreshFile",[]),fireEditEvent:t=>C("fireEditEvent",[t]),exportTable:(t,l,n,o,a,i)=>C("exportTable",[t,l,n,o,a,i]),updateCell:(t,l,n,o,a)=>C("updateCell",[t,l,n,o,a]),insertRow:(t,l)=>C("insertRow",[t,l]),deleteRows:(t,l)=>C("deleteRows",[t,l]),deleteColumns:(t,l)=>C("deleteColumns",[t,l]),createTable:(t,l)=>C("createTable",[t,l]),updateCellBatch:(t,l,n)=>C("updateCellBatch",[t,l,n]),addColumn:(t,l,n,o)=>C("addColumn",[t,l,n,o]),fetchTableData:(t,l)=>C("fetchTableData",[t,l]),fetchTableCount:(t,l)=>C("fetchTableCount",[t,l]),fetchSchema:()=>C("fetchSchema",[]),getTableInfo:t=>C("getTableInfo",[t]),getPragmas:()=>C("getPragmas",[]),setPragma:(t,l)=>C("setPragma",[t,l]),getExtensionSettings:()=>C("getExtensionSettings",[]),updateExtensionSetting:(t,l)=>C("updateExtensionSetting",[t,l]),ping:()=>C("ping",[]),openCellEditor:(t,l,n,o,a)=>C("openCellEditor",[t,l,n,o,a]),readWorkspaceFileUri:t=>C("readWorkspaceFileUri",[t]),triggerUndo:()=>C("triggerUndo",[]),triggerRedo:()=>C("triggerRedo",[])};function y(t){return t==null?"":String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function le(t){let l=Number(t);if(!Number.isFinite(l))throw new Error(`Invalid rowid: ${t}`);return l}function K(t,l=null,n="raw",o=null){if(t==null)return"NULL";if(t instanceof Uint8Array)return"[BLOB]";if(n!=="raw"&&Ut(l,o)){let i=Ft(t,n);if(i)return y(i)}return typeof t=="string"&&t.length>100?y(t.substring(0,100))+"...":y(String(t))}function Ut(t,l){if(t){let n=t.toUpperCase();if(n.includes("DATE")||n.includes("TIME")||n.includes("TIMESTAMP"))return!0}if(l){let n=l.toUpperCase();return n.endsWith("_AT")||n.endsWith("_ON")||n.includes("DATE")||n.includes("TIME")||n==="CREATED"||n==="UPDATED"}return!1}function Ft(t,l){if(!t)return null;let n;if(t instanceof Date)n=t;else if(typeof t=="number")t<1e11?n=new Date(t*1e3):n=new Date(t);else{let o=String(t);/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(o)&&(o=o.replace(" ","T"));let a=Date.parse(o);if(isNaN(a))return null;n=new Date(a)}if(isNaN(n.getTime()))return null;switch(l){case"local":return n.toLocaleString();case"iso":return n.toISOString();case"relative":return Ot(n);default:return String(t)}}function Ot(t){let l=Math.floor((new Date-t)/1e3),n={year:31536e3,month:2592e3,week:604800,day:86400,hour:3600,minute:60,second:1},o;for(let[a,i]of Object.entries(n))if(o=Math.floor(l/i),o>0)return o===1?`1 ${a} ago`:`${o} ${a}s ago`;return"Just now"}function c(t){let l=document.getElementById("statusText");l&&(l.textContent=t)}function Ve(){let t=document.getElementById("gridContainer");t&&(t.innerHTML=`
            <div class="loading-view">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
        `)}function qe(){let t=document.getElementById("gridContainer");t&&(t.innerHTML=`
            <div class="empty-view">
                <span class="empty-icon codicon codicon-database"></span>
                <span class="empty-title">Select a table</span>
                <span class="empty-desc">Choose a table from the sidebar to view data</span>
            </div>
        `)}function ne(t){let l=document.getElementById("gridContainer");l&&(l.innerHTML=`
            <div class="empty-view">
                <span class="empty-icon codicon codicon-error" style="color: var(--error-color)"></span>
                <span class="empty-title">Error</span>
                <span class="empty-desc">${y(t)}</span>
            </div>
        `)}function T(){let t=e.selectedTable&&e.selectedTableType==="table",l=e.selectedRowIds.size>0,n=e.selectedColumns.size>0,o=document.getElementById("btnAddRow"),a=document.getElementById("btnAddColumn"),i=document.getElementById("btnDeleteRows"),s=document.getElementById("btnExport");o&&(o.disabled=!t),a&&(a.disabled=!t),i&&(i.disabled=!t||!l&&!n),s&&(s.disabled=!e.selectedTable)}function He(){let t=document.getElementById("sidebarPanel"),l=document.getElementById("resizeHandle");if(!t||!l)return;let n=!1;l.addEventListener("mousedown",o=>{n=!0,document.body.style.cursor="col-resize",o.preventDefault()}),document.addEventListener("mousemove",o=>{if(!n)return;let a=Math.max(150,Math.min(400,o.clientX));t.style.width=a+"px"}),document.addEventListener("mouseup",()=>{n&&(n=!1,document.body.style.cursor="")})}function I(){return e.selectedTableType==="table"?1:0}function v(t,l){return e.selectedTableType==="table"?t[0]:e.currentPageIndex*e.rowsPerPage+l}function S(t,l){return t[l+I()]}function Ke(t,l,n){if(e.selectedTableType!=="table"){c("Views are read-only");return}if(e.editingCellInfo){if(e.editingCellInfo.rowIdx===t&&e.editingCellInfo.colIdx===l)return;ae()}let o=e.tableColumns[l];if(!o)return;let a=document.getElementById(`cell-${t}-${l}`);if(!a)return;let i=e.gridData[t],s=S(i,l);if(s instanceof Uint8Array){U(t,l,n);return}if(typeof s=="string"){let u=s.trim();if(u.startsWith("{")&&u.endsWith("}")||u.startsWith("[")&&u.endsWith("]"))try{JSON.parse(u),U(t,l,n);return}catch{}}e.editingCellInfo={rowIdx:t,colIdx:l,rowId:n,columnName:o.name,originalValue:s};let r=s===null?"":String(s);a.innerHTML="",a.classList.add("editing");let m=document.createElement("textarea");m.className="cell-input",m.value=r,m.spellcheck=!1,a.appendChild(m),m.focus(),e.activeCellInput=m,m.addEventListener("keydown",je),m.addEventListener("blur",_e),m.addEventListener("click",u=>u.stopPropagation()),e.isTransitioningEdit=!0,setTimeout(()=>{e.isTransitioningEdit=!1},100)}function je(t){t.key==="Enter"&&!t.shiftKey?(t.preventDefault(),Je()):t.key==="Escape"&&(t.preventDefault(),ae())}function _e(){setTimeout(()=>{e.editingCellInfo&&Je()},100)}async function Je(){if(e.isSavingCell||!e.editingCellInfo||!e.activeCellInput)return;let{rowIdx:t,colIdx:l,rowId:n,columnName:o,originalValue:a}=e.editingCellInfo,i=e.activeCellInput.value,s=a===null?"":String(a);if(i===s){ae(),e.selectedCells=[],e.lastSelectedCell=null,B();return}let r=e.tableColumns[l],m=r&&r.notnull===1,u;i===""?m?u="":u=null:!isNaN(Number(i))&&i.trim()!==""?u=Number(i):u=i;try{e.isSavingCell=!0,c("Saving..."),await f.updateCell(e.selectedTable,le(n),o,u,a),e.gridData[t][l+I()]=u,Xe(),be(t,l,u),e.selectedCells=[],e.lastSelectedCell=null,B(),c("Saved")}catch(p){console.error("Save failed:",p);let g=p.message||String(p);c(`Save failed: ${g}`)}finally{e.isSavingCell=!1}}function ae(){if(!e.editingCellInfo)return;let{rowIdx:t,colIdx:l,originalValue:n}=e.editingCellInfo;Xe(),be(t,l,n),ie()}function Xe(){e.activeCellInput&&(e.activeCellInput.removeEventListener("keydown",je),e.activeCellInput.removeEventListener("blur",_e),e.activeCellInput=null),e.editingCellInfo=null}async function se(){if(!e.cellPreviewInfo)return;let{rowIdx:t,colIdx:l,rowId:n,columnName:o,originalValue:a}=e.cellPreviewInfo,i=e.tableColumns[l],s=document.getElementById("vscode-env")?.dataset.webviewId||"default";try{c("Opening in VS Code..."),j(),await f.openCellEditor({table:e.selectedTable,name:""},le(n),o,{},{value:a,type:{type:i.type},webviewId:s,rowCount:e.gridData.length}),c("Opened in VS Code")}catch(r){console.error("Failed to open in VS Code:",r),c(`Error: ${r.message}`)}}function U(t,l,n){e.editingCellInfo&&ae();let o=e.tableColumns[l];if(!o)return;let a=e.gridData[t];if(!a)return;let i=S(a,l);e.cellPreviewInfo={rowIdx:t,colIdx:l,rowId:n,columnName:o.name,originalValue:i};let s=document.getElementById("cellPreviewModal"),r=document.getElementById("cellPreviewColumnName"),m=document.getElementById("cellPreviewTypeBadge"),u=document.getElementById("cellPreviewTextarea"),p=document.getElementById("cellPreviewReadonlyBadge"),g=document.getElementById("cellPreviewSaveBtn"),b=document.getElementById("wrapTextBtn");r.textContent=o.name,m.textContent=o.type||"TEXT";let R="";i==null?R="":i instanceof Uint8Array?R="[BLOB: "+Array.from(i).map(x=>x.toString(16).padStart(2,"0")).join(" ")+"]":R=String(i),u.value=R;let W=e.selectedTableType!=="table";u.readOnly=W,W?(u.classList.add("readonly"),p.style.display="inline",g.style.display="none"):(u.classList.remove("readonly"),p.style.display="none",g.style.display="inline-block"),oe(),u.style.whiteSpace=e.cellPreviewWrapEnabled?"pre-wrap":"pre",u.style.overflowX=e.cellPreviewWrapEnabled?"hidden":"auto",b.classList.toggle("active",e.cellPreviewWrapEnabled),s.classList.remove("hidden"),u.focus(),u.oninput=oe,u.onkeydown=x=>{x.key==="Escape"?(x.preventDefault(),j()):x.key==="Enter"&&(x.ctrlKey||x.metaKey)&&(x.preventDefault(),we())}}function oe(){let t=document.getElementById("cellPreviewTextarea"),l=document.getElementById("cellPreviewCharCount"),n=t.value.length;l.textContent=`${n.toLocaleString()} character${n!==1?"s":""}`}function j(){document.getElementById("cellPreviewModal").classList.add("hidden"),e.cellPreviewInfo=null}async function we(){if(!e.cellPreviewInfo)return;if(e.selectedTableType!=="table"){c("Views are read-only");return}let{rowIdx:t,colIdx:l,rowId:n,columnName:o,originalValue:a}=e.cellPreviewInfo,s=document.getElementById("cellPreviewTextarea").value,r=a===null?"":String(a);if(s===r){j(),e.selectedCells=[],e.lastSelectedCell=null,B();return}let m=e.tableColumns[l],u=m&&m.notnull===1,p;s===""?p=u?"":null:!isNaN(Number(s))&&s.trim()!==""?p=Number(s):p=s;try{c("Saving..."),await f.updateCell(e.selectedTable,le(n),o,p,a),e.gridData[t][l+I()]=p,j(),be(t,l,p),e.selectedCells=[],e.lastSelectedCell=null,B(),c("Saved")}catch(g){console.error("Save failed:",g),c(`Save failed: ${g.message}`)}}function Ge(){let t=document.getElementById("cellPreviewTextarea");try{let l=JSON.parse(t.value);t.value=JSON.stringify(l,null,2),oe()}catch{c("Content is not valid JSON")}}function Qe(){let t=document.getElementById("cellPreviewTextarea");try{let l=JSON.parse(t.value);t.value=JSON.stringify(l),oe()}catch{c("Content is not valid JSON")}}function Ze(){e.cellPreviewWrapEnabled=!e.cellPreviewWrapEnabled;let t=document.getElementById("cellPreviewTextarea"),l=document.getElementById("wrapTextBtn");t.style.whiteSpace=e.cellPreviewWrapEnabled?"pre-wrap":"pre",t.style.overflowX=e.cellPreviewWrapEnabled?"hidden":"auto",l.classList.toggle("active",e.cellPreviewWrapEnabled)}function be(t,l,n){let o=document.getElementById(`cell-${t}-${l}`);if(!o)return;o.classList.remove("editing"),n==null?o.classList.add("null-value"):o.classList.remove("null-value");let a=e.tableColumns[l],i=K(n,a?.type,e.dateFormat,a?.name),s=n!=null&&!(n instanceof Uint8Array),r=`<span class="cell-text">${i}</span>`;s&&(r+='<span class="expand-icon codicon codicon-link-external" title="View full content"></span>'),o.innerHTML=r;let m=o.querySelector(".cell-text");if(m){let u=m.scrollWidth>m.clientWidth;o.classList.toggle("has-overflow",u)}}async function A(){if(e.isDbConnected)try{let t=await f.fetchSchema();e.schemaCache.tables=(t.tables||[]).map(l=>({name:l.identifier})),e.schemaCache.views=(t.views||[]).map(l=>({name:l.identifier})),e.schemaCache.indexes=(t.indexes||[]).map(l=>({name:l.identifier,table:l.parentTable})),Ye()}catch(t){console.error("Error loading schema:",t),c("Error loading schema")}}function Ye(){let t=document.getElementById("tablesBadge"),l=document.getElementById("viewsBadge"),n=document.getElementById("indexesBadge");t&&(t.textContent=e.schemaCache.tables.length),l&&(l.textContent=e.schemaCache.views.length),n&&(n.textContent=e.schemaCache.indexes.length);let o=document.getElementById("tablesList");o&&(e.schemaCache.tables.length===0?o.innerHTML='<li class="list-item" style="opacity:0.5">No tables</li>':o.innerHTML=e.schemaCache.tables.map(s=>`
                <li class="list-item ${e.selectedTable===s.name&&e.selectedTableType==="table"?"selected":""}"
                    onclick="selectTableItem('${y(s.name)}', 'table')"
                    title="${y(s.name)}">
                    <span class="item-icon codicon codicon-table"></span>
                    <span class="item-name">${y(s.name)}</span>
                </li>
            `).join(""));let a=document.getElementById("viewsList");a&&(e.schemaCache.views.length===0?a.innerHTML='<li class="list-item" style="opacity:0.5">No views</li>':a.innerHTML=e.schemaCache.views.map(s=>`
                <li class="list-item ${e.selectedTable===s.name&&e.selectedTableType==="view"?"selected":""}"
                    onclick="selectTableItem('${y(s.name)}', 'view')"
                    title="${y(s.name)}">
                    <span class="item-icon codicon codicon-eye"></span>
                    <span class="item-name">${y(s.name)}</span>
                </li>
            `).join(""));let i=document.getElementById("indexesList");i&&(e.schemaCache.indexes.length===0?i.innerHTML='<li class="list-item" style="opacity:0.5">No indexes</li>':i.innerHTML=e.schemaCache.indexes.map(s=>`
                <li class="list-item" title="${y(s.name)} on ${y(s.table)}">
                    <span class="item-icon codicon codicon-list-selection"></span>
                    <div class="item-content">
                        <span class="item-name">${y(s.name)}</span>
                        <span class="item-detail">${y(s.table)}</span>
                    </div>
                </li>
            `).join(""))}function F(){let t=document.getElementById("batchUpdateSectionTitle"),l=document.getElementById("batchUpdateList"),n=document.getElementById("batchUpdateCount"),o=document.getElementById("batchUpdateFields");if(!t||!l||!n||!o)return;let a=e.selectedCells.length;if(a===0){t.classList.add("hidden"),l.classList.add("hidden");return}t.classList.remove("hidden"),l.classList.remove("hidden"),t.classList.remove("collapsed"),n.textContent=a;let i=new Map;for(let r of e.selectedCells){if(!i.has(r.colIdx)){let m=e.tableColumns[r.colIdx];i.set(r.colIdx,{name:m.name,type:m.type,values:new Set})}i.get(r.colIdx).values.add(r.value)}let s="";for(let[r,m]of i){let u=Array.from(m.values),p=u.length>1,g="";if(p)g="(mixed values)";else{let b=u[0];b===null?g="NULL":b instanceof Uint8Array?g="[BLOB]":g=String(b)}s+=`
            <div class="form-field batch-field" data-colidx="${r}" style="margin-bottom:8px">
                <label style="font-size:11px; color:var(--text-secondary)">${y(m.name)} <span style="opacity:0.7">${m.type||""}</span></label>
                <div style="display:flex; gap:4px">
                    <input type="text" class="batch-input" placeholder="${y(g)}" data-colidx="${r}" style="flex:1; min-width:0">
                    <button class="btn-secondary" style="padding:2px 6px;" title="Set to NULL" onclick="setBatchNull(${r})">NULL</button>
                    <button class="btn-secondary" style="padding:2px 6px;" title="JSON Patch" onclick="toggleBatchPatch(${r}, this)">{}</button>
                </div>
            </div>
        `}o.innerHTML=s}async function et(){if(e.selectedCells.length===0)return;let t=document.querySelectorAll(".batch-input"),l=new Map;for(let o of t){let a=parseInt(o.dataset.colidx,10);if(l.set(a,o),o.dataset.ispatch==="true")try{JSON.parse(o.value)}catch{let s=e.tableColumns[a];c(`Invalid JSON for patch in ${s.name}`);return}}let n=[];for(let o of e.selectedCells){let a=l.get(o.colIdx);if(!a)continue;let i=a.dataset.isnull==="true",s=a.dataset.ispatch==="true",r=a.value;if(r===""&&!i)continue;let m=e.tableColumns[o.colIdx],u=r,p="set";i?u=null:s?p="json_patch":(m.type==="INTEGER"||m.type==="REAL"||m.type==="NUMERIC")&&!isNaN(Number(r))&&r.trim()!==""&&(u=Number(r)),n.push({rowId:o.rowId,column:m.name,value:u,originalValue:o.value,operation:p,rowIdx:o.rowIdx,colIdx:o.colIdx})}if(n.length===0){c("No values entered for batch update");return}try{c(`Updating ${n.length} cells...`);let o=`Batch update ${n.length} cells`,a=n.map(r=>({rowId:r.rowId,column:r.column,value:r.value,originalValue:r.originalValue,operation:r.operation}));if(await f.updateCellBatch(e.selectedTable,a,o),!n.some(r=>r.operation==="json_patch"))for(let r of n)e.gridData[r.rowIdx][r.colIdx+I()]=r.value;await w(!1);let s=[];for(let r of e.selectedCells){let m=e.gridData[r.rowIdx][r.colIdx+I()];s.push({...r,value:m})}e.selectedCells=s,F(),c("Batch update completed")}catch(o){console.error("Batch update failed:",o),c(`Batch update failed: ${o.message}`)}}function tt(t){let l=document.querySelector(`.batch-input[data-colidx="${t}"]`),n=document.querySelector(`.batch-field[data-colidx="${t}"] button[title="JSON Patch"]`);l&&(l.value="",l.placeholder="SET TO NULL",l.dataset.isnull="true",l.dataset.ispatch="false",l.style.fontStyle="italic",n&&(n.style.background="",n.style.color=""))}function lt(t,l){let n=document.querySelector(`.batch-input[data-colidx="${t}"]`);n&&(n.dataset.ispatch==="true"?(n.dataset.ispatch="false",n.placeholder="(mixed values)",l.style.background="",l.style.color=""):(n.dataset.ispatch="true",n.dataset.isnull="false",n.placeholder='JSON Patch (e.g. {"a": 1})',n.style.fontStyle="normal",l.style.background="var(--accent-color)",l.style.color="white"))}function nt(t){let l=document.getElementById(`${t}List`),n=document.querySelector(`.section-title[data-section="${t}"]`);l&&n&&(l.classList.toggle("hidden"),n.classList.toggle("collapsed"))}async function ot(t,l){e.selectedTable=t,e.selectedTableType=l,e.currentPageIndex=0,e.sortedColumn=null,e.sortAscending=!0,e.filterQuery="",e.columnFilters={},e.selectedRowIds.clear(),e.selectedCells=[],e.lastSelectedCell=null,e.selectedColumns.clear(),e.pinnedColumns.clear(),e.pinnedRowIds.clear(),e.columnWidths={},e.scrollPosition={top:0,left:0},Ye();let n=document.getElementById("tableNameLabel");n&&(n.textContent=t);let o=document.getElementById("filterInput");o&&(o.value=""),await z(),await w(!0,!1)}async function at(){if(e.isDbConnected)try{c("Reloading..."),await f.refreshFile(),await A(),e.selectedTable&&(await z(),await w()),c("Reloaded")}catch(t){console.error("Reload failed:",t),c(`Reload failed: ${t.message}`)}}var Z=new Set,Y=new Set;function st(){let t=document.getElementById("gridContainer");t&&(t.addEventListener("mousedown",l=>{if(l.target.classList.contains("resize-handle")){l.stopPropagation();let n=l.target.closest(".header-cell");n&&n.dataset.column&&Se(l,n.dataset.column)}}),t.addEventListener("keydown",l=>{if(l.target.classList.contains("column-filter")){let n=l.target.dataset.column;n&&ve(l,n)}}),t.addEventListener("click",l=>{let n=l.target;if(n.closest(".grid-header")){if(n.closest(".filter-apply-btn")){l.stopPropagation();let s=n.closest(".header-cell");s&&s.dataset.column&&re(s.dataset.column);return}if(n.closest(".header-bottom")||n.closest(".column-filter")){l.stopPropagation();return}if(n.closest(".select-column-icon")){l.stopPropagation();let s=n.closest(".header-cell");s&&s.dataset.column&&Ie(l,s.dataset.column);return}if(n.closest(".pin-icon")){l.stopPropagation();let s=n.closest(".header-cell");s&&s.dataset.column&&Ee(l,s.dataset.column);return}if(n.closest(".row-number-header")){ce(l);return}let i=n.closest(".header-top");if(i){let s=i.closest(".header-cell");s&&s.dataset.column&&xe(s.dataset.column);return}return}if(n.closest(".pin-icon")){let i=n.closest(".data-row");if(i){let s=i.dataset.rowid,r=_(s);Te(l,r)}return}if(n.closest(".expand-icon")){let i=n.closest(".data-cell");if(i){let s=parseInt(i.dataset.rowidx,10),r=parseInt(i.dataset.colidx,10),m=_(i.closest(".data-row").dataset.rowid);U(s,r,m)}return}if(n.closest(".row-number")){let i=n.closest(".data-row");if(i){let s=_(i.dataset.rowid);$e(l,s)}return}let o=n.closest(".data-cell");if(o){let i=parseInt(o.dataset.rowidx,10),s=parseInt(o.dataset.colidx,10),r=o.closest(".data-row"),m=_(r.dataset.rowid);Pe(l,i,s,m);return}let a=n.closest(".data-row");if(a){let i=parseInt(a.dataset.rowidx,10),s=_(a.dataset.rowid);}}),t.addEventListener("dblclick",l=>{let n=l.target.closest(".data-cell");if(n&&!n.classList.contains("row-number")){let o=parseInt(n.dataset.rowidx,10),a=parseInt(n.dataset.colidx,10),i=n.closest(".data-row"),s=_(i.dataset.rowid);Re(l,o,a,s)}}),t.addEventListener("mouseover",l=>{let n=l.target.closest(".data-cell");if(n&&!n.classList.contains("checked-overflow")){let o=n.querySelector(".cell-text");if(o){let a=o.scrollWidth>o.clientWidth;n.classList.toggle("has-overflow",a),n.classList.add("checked-overflow")}}}))}function _(t){if(t==null)return t;let l=Number(t);return isNaN(l)?t:l}async function z(){if(e.selectedTable)try{let t=await f.getTableInfo(e.selectedTable);e.tableColumns=t.map(n=>({cid:n.ordinal,name:n.identifier,type:n.declaredType,notnull:n.isRequired,dflt_value:n.defaultExpression,isPrimaryKey:n.primaryKeyPosition>0})).sort((n,o)=>n.cid-o.cid);let l=new Set(e.tableColumns.map(n=>n.name));e.sortedColumn&&!l.has(e.sortedColumn)&&(e.sortedColumn=null,e.sortAscending=!0);for(let n of Object.keys(e.columnFilters))l.has(n)||delete e.columnFilters[n]}catch(t){console.error("Error loading columns:",t),c("Error loading columns")}}async function w(t=!0,l=!0){if(!e.selectedTable)return;let n=document.getElementById("gridContainer");l&&n&&n.querySelector(".data-grid")&&(e.scrollPosition.left=n.scrollLeft,e.scrollPosition.top=n.scrollTop),t&&(e.isLoadingData=!0,Ve()),T();try{let o=[];for(let[p,g]of Object.entries(e.columnFilters))g&&g.trim()&&o.push({column:p,value:g});let a={filters:o,globalFilter:e.filterQuery,columns:e.tableColumns.map(p=>p.name)};e.totalRecordCount=await f.fetchTableCount(e.selectedTable,a),e.totalPageCount=Math.max(1,Math.ceil(e.totalRecordCount/e.rowsPerPage)),e.currentPageIndex>=e.totalPageCount&&(e.currentPageIndex=Math.max(0,e.totalPageCount-1));let i=e.selectedTableType==="table",s=e.tableColumns.map(p=>p.name),m={columns:i?["rowid",...s]:s,orderBy:e.sortedColumn,orderDir:e.sortAscending?"ASC":"DESC",limit:e.rowsPerPage,offset:e.currentPageIndex*e.rowsPerPage,filters:o,globalFilter:e.filterQuery},u=await f.fetchTableData(e.selectedTable,m);e.gridData=u.rows||[],!t&&n&&n.querySelector(".data-grid")&&(e.scrollPosition.left=n.scrollLeft,e.scrollPosition.top=n.scrollTop),!t&&e.editingCellInfo||ee(e.scrollPosition.top,e.scrollPosition.left),n&&(n.scrollLeft=e.scrollPosition.left,n.scrollTop=e.scrollPosition.top),Wt(),c(`${e.totalRecordCount} records`)}catch(o){console.error("Error loading data:",o),c(`Error: ${o.message}`),ne(o.message)}finally{t&&(e.isLoadingData=!1)}}function ee(t=null,l=null){let i=document.getElementById("gridContainer");if(!i)return;let s=i.scrollLeft,r=i.scrollTop,m=l!==null?l:s,u=t!==null?t:r,p=Object.values(e.columnFilters).some(d=>d&&d.trim()!=="");if(i.innerHTML="",e.gridData.length===0&&!p&&e.tableColumns.length===0){let d=document.createElement("div");d.className="empty-view",d.innerHTML=`
            <span class="empty-icon codicon codicon-database"></span>
            <span class="empty-title">No data</span>
            <span class="empty-desc">This table is empty</span>
        `,i.appendChild(d);return}let g=new Set;if(e.selectedCells.length>0)for(let d of e.selectedCells)g.add(`${d.rowIdx},${d.colIdx}`);let b=document.createElement("table");b.className="data-grid";let R=document.createElement("thead");R.className="grid-header";let W=document.createElement("tr");if(Object.keys(e.columnWidths).length===0&&e.gridData.length>0)for(let d of e.tableColumns){let h=d.name.length,k=d.isPrimaryKey?86:70,X=h*8+k;e.columnWidths[d.name]=Math.max(80,Math.min(250,X))}let x=[...e.tableColumns.filter(d=>e.pinnedColumns.has(d.name)),...e.tableColumns.filter(d=>!e.pinnedColumns.has(d.name))],ue=new Map,Ne=49;for(let d of x)e.pinnedColumns.has(d.name)&&(ue.set(d.name,Ne),Ne+=e.columnWidths[d.name]||120);let ke=new Map;e.tableColumns.forEach((d,h)=>ke.set(d.name,h));let J=document.createElement("th");J.className="header-cell row-number-header",Object.assign(J.style,{width:"50px",minWidth:"50px",maxWidth:"50px",position:"sticky",left:"0",top:"0",zIndex:"11",background:"var(--bg-secondary)"}),J.title="Click to select all rows",J.innerHTML='<div class="header-content"><div class="header-top" style="height:100%;justify-content:center">#</div></div>',W.appendChild(J);for(let d of x){let h=e.sortedColumn===d.name,k=e.pinnedColumns.has(d.name),X=e.selectedColumns.has(d.name),N=e.columnWidths[d.name]||120,L=e.columnFilters[d.name]||"",E=document.createElement("th");E.className=`header-cell ${k?"pinned":""} ${X?"column-selected":""}`,Object.assign(E.style,{width:`${N}px`,minWidth:`${N}px`,maxWidth:`${N}px`}),k&&(E.style.position="sticky",E.style.left=`${ue.get(d.name)}px`),E.dataset.column=d.name;let te=y(d.name),G=y(L),M=h?`<span class="sort-indicator">${e.sortAscending?"\u25B2":"\u25BC"}</span>`:"",V=d.isPrimaryKey?'<span class="key-icon codicon codicon-key" title="Primary Key"></span>':"",q=k?"pinned":"",fe=k?"Unpin column":"Pin column";E.innerHTML=`
            <div class="header-content">
                <div class="header-top">
                    ${V}<span class="header-text">${te}${M}</span>
                    <span class="select-column-icon codicon codicon-selection" title="Select entire column"></span>
                    <span class="pin-icon codicon codicon-pin ${q}" title="${fe}"></span>
                </div>
                <div class="header-bottom">
                    <input type="text" class="column-filter" data-column="${te}" value="${G}" placeholder="Filter...">
                    <button class="filter-apply-btn" title="Apply filter (Enter)"><span class="codicon codicon-search"></span></button>
                </div>
            </div>
            <div class="resize-handle"></div>
        `,W.appendChild(E)}R.appendChild(W),b.appendChild(R);let Me=document.createElement("tbody"),me=[];for(let d=0;d<e.gridData.length;d++){let h=v(e.gridData[d],d);e.pinnedRowIds.has(h)&&me.push({rowIdx:d,rowId:h,row:e.gridData[d]})}let Ae=new Map;for(let d=0;d<me.length;d++){let h=52+d*26;Ae.set(me[d].rowId,h)}let Mt=[...e.gridData.map((d,h)=>({idx:h,rowId:v(d,h)})).filter(d=>e.pinnedRowIds.has(d.rowId)),...e.gridData.map((d,h)=>({idx:h,rowId:v(d,h)})).filter(d=>!e.pinnedRowIds.has(d.rowId))],pe=document.createDocumentFragment();for(let{idx:d,rowId:h}of Mt){let k=e.gridData[d],X=e.selectedRowIds.has(h),N=e.pinnedRowIds.has(h),L=document.createElement("tr");L.id=`row-${d}`,L.className=`data-row ${X?"selected":""} ${N?"pinned":""}`,L.dataset.rowid=h,L.dataset.rowidx=d,N&&(L.style.top=`${Ae.get(h)}px`);let E=document.createElement("td");E.className="data-cell row-number",Object.assign(E.style,{width:"50px",minWidth:"50px",maxWidth:"50px",position:"sticky",left:"0",zIndex:N?"8":"2"});let te=e.currentPageIndex*e.rowsPerPage+d+1;E.innerHTML=`${te}<span class="pin-icon codicon codicon-pin ${N?"pinned":""}" title="${N?"Unpin row":"Pin row"}"></span>`,L.appendChild(E);for(let G=0;G<x.length;G++){let M=x[G],V=ke.get(M.name),q=S(k,V),fe=K(q,M.type,e.dateFormat,M.name),ze=q==null,At=g.has(`${d},${V}`),Ue=e.pinnedColumns.has(M.name),Fe=!ze&&!(q instanceof Uint8Array),ge=e.columnWidths[M.name]||120,$=document.createElement("td");$.id=`cell-${d}-${V}`,$.className=`data-cell ${ze?"null-value":""} ${At?"cell-selected":""} ${Ue?"pinned":""}`,$.dataset.rowidx=d,$.dataset.colidx=V,Object.assign($.style,{width:`${ge}px`,minWidth:`${ge}px`,maxWidth:`${ge}px`}),Fe&&($.style.position="relative"),Ue&&($.style.position="sticky",$.style.left=`${ue.get(M.name)}px`);let he=document.createElement("span");if(he.className="cell-text",he.innerHTML=fe,$.appendChild(he),Fe){let ye=document.createElement("span");ye.className="expand-icon codicon codicon-link-external",ye.title="View full content",$.appendChild(ye)}L.appendChild($)}pe.appendChild(L)}if(e.gridData.length===0&&p){let d=document.createElement("tr");d.className="no-results-row";let h=document.createElement("td");h.colSpan=x.length+1,Object.assign(h.style,{textAlign:"center",padding:"20px",color:"var(--text-secondary)"}),h.textContent="No rows match the current filter. Modify or clear filters above.",d.appendChild(h),pe.appendChild(d)}Me.appendChild(pe),b.appendChild(Me),i.appendChild(b),i.scrollLeft=m,i.scrollTop=u,Z.clear(),e.selectedCells.length>0&&e.selectedCells.forEach(d=>{Z.add(`cell-${d.rowIdx}-${d.colIdx}`)}),Y.clear(),e.selectedRowIds.size>0&&document.querySelectorAll(".data-row.selected").forEach(h=>{h.id&&Y.add(h.id)})}function B(){let t=new Set;for(let n of e.selectedCells)t.add(`cell-${n.rowIdx}-${n.colIdx}`);for(let n of Z)if(!t.has(n)){let o=document.getElementById(n);o&&o.classList.remove("cell-selected")}for(let n of t)if(!Z.has(n)){let o=document.getElementById(n);o&&o.classList.add("cell-selected")}Z=t;let l=new Set;for(let n=0;n<e.gridData.length;n++){let o=v(e.gridData[n],n);(e.selectedRowIds.has(o)||typeof o!="string"&&e.selectedRowIds.has(String(o)))&&l.add(`row-${n}`)}for(let n of Y)if(!l.has(n)){let o=document.getElementById(n);o&&o.classList.remove("selected")}for(let n of l)if(!Y.has(n)){let o=document.getElementById(n);o&&o.classList.add("selected")}Y=l,document.querySelectorAll(".header-cell.column-selected").forEach(n=>n.classList.remove("column-selected")),e.selectedColumns.size>0&&e.selectedColumns.forEach(n=>{let o=CSS.escape(n),a=document.querySelector(`.header-cell[data-column="${o}"]`);a&&a.classList.add("column-selected")})}function Wt(){document.getElementById("pageIndicator").textContent=`${e.currentPageIndex+1} / ${e.totalPageCount}`,document.getElementById("btnFirst").disabled=e.currentPageIndex===0,document.getElementById("btnPrev").disabled=e.currentPageIndex===0,document.getElementById("btnNext").disabled=e.currentPageIndex>=e.totalPageCount-1,document.getElementById("btnLast").disabled=e.currentPageIndex>=e.totalPageCount-1}function it(){clearTimeout(e.filterTimer),e.filterTimer=setTimeout(()=>{e.filterQuery=document.getElementById("filterInput").value,e.currentPageIndex=0,w()},300)}function rt(){e.rowsPerPage=parseInt(document.getElementById("pageSizeSelect").value,10),e.currentPageIndex=0,w()}function ct(){let t=document.getElementById("dateFormatSelect");t&&(e.dateFormat=t.value,ee())}function dt(t){t>=0&&t<e.totalPageCount&&(e.currentPageIndex=t,e.scrollPosition={top:0,left:0},w(!0,!1))}function xe(t){e.sortedColumn===t?e.sortAscending=!e.sortAscending:(e.sortedColumn=t,e.sortAscending=!0),w()}function re(t){let l=document.querySelector(`.column-filter[data-column="${t}"]`);l&&(e.columnFilters[t]=l.value,e.currentPageIndex=0,w())}function ve(t,l){t.key==="Enter"&&re(l)}function Ie(t,l){t.stopPropagation();let n=e.tableColumns.findIndex(s=>s.name===l);if(n===-1)return;e.selectedRowIds.clear();let o=e.gridData.length,a=0;for(let s of e.selectedCells)s.colIdx===n&&a++;let i=o>0&&a===o;if(t.metaKey||t.ctrlKey)if(i)e.selectedCells=e.selectedCells.filter(s=>s.colIdx!==n),e.selectedColumns.delete(l);else{let s=new Set;for(let r of e.selectedCells)s.add(`${r.rowIdx},${r.colIdx}`);for(let r=0;r<e.gridData.length;r++)if(!s.has(`${r},${n}`)){let m=v(e.gridData[r],r),u=S(e.gridData[r],n);e.selectedCells.push({rowIdx:r,colIdx:n,rowId:m,value:u}),s.add(`${r},${n}`)}e.selectedColumns.add(l)}else if(i&&e.selectedColumns.size===1&&e.selectedColumns.has(l))e.selectedCells=[],e.selectedColumns.clear();else{e.selectedCells=[],e.selectedColumns.clear();for(let s=0;s<e.gridData.length;s++){let r=v(e.gridData[s],s),m=S(e.gridData[s],n);e.selectedCells.push({rowIdx:s,colIdx:n,rowId:r,value:m})}e.selectedColumns.add(l)}e.lastSelectedCell=null,B(),T(),F()}function Ee(t,l){t.stopPropagation(),e.pinnedColumns.has(l)?e.pinnedColumns.delete(l):e.pinnedColumns.add(l),ee()}function Te(t,l){t.stopPropagation(),e.pinnedRowIds.has(l)?e.pinnedRowIds.delete(l):e.pinnedRowIds.add(l),ee()}function Se(t,l){t.stopPropagation(),e.resizingColumn=l,e.resizeStartX=t.clientX,e.resizeStartWidth=e.columnWidths[l]||120,t.target.classList.add("resizing"),document.body.style.userSelect="none",document.body.style.cursor="col-resize",document.addEventListener("mousemove",ut),document.addEventListener("mouseup",mt)}function ut(t){if(!e.resizingColumn)return;let l=t.clientX-e.resizeStartX,n=Math.max(30,e.resizeStartWidth+l);e.columnWidths[e.resizingColumn]=n;let o=e.tableColumns.findIndex(s=>s.name===e.resizingColumn);if(o===-1)return;let a=document.querySelector(`th[data-column="${e.resizingColumn}"]`);a&&(a.style.width=`${n}px`,a.style.minWidth=`${n}px`,a.style.maxWidth=`${n}px`);let i=document.querySelectorAll(`.data-row td:nth-child(${o+2})`);for(let s of i)s.style.width=`${n}px`,s.style.minWidth=`${n}px`,s.style.maxWidth=`${n}px`;e.pinnedColumns.has(e.resizingColumn)}function mt(){if(!e.resizingColumn)return;let t=document.querySelector(".resize-handle.resizing");t&&t.classList.remove("resizing"),e.resizingColumn=null,document.removeEventListener("mousemove",ut),document.removeEventListener("mouseup",mt),document.body.style.userSelect="",document.body.style.cursor="",ee()}function pt(t,l,n){}function $e(t,l){t.stopPropagation(),e.selectedCells=[],e.lastSelectedCell=null,e.selectedColumns.clear(),t.ctrlKey||t.metaKey?e.selectedRowIds.has(l)?e.selectedRowIds.delete(l):e.selectedRowIds.add(l):e.selectedRowIds.has(l)&&e.selectedRowIds.size===1?e.selectedRowIds.delete(l):(e.selectedRowIds.clear(),e.selectedRowIds.add(l)),B(),T(),F()}function ce(t){if(t.stopPropagation(),e.gridData.length===0)return;e.selectedCells=[],e.lastSelectedCell=null,e.selectedColumns.clear();let l=!0;for(let n=0;n<e.gridData.length;n++){let o=v(e.gridData[n],n);if(!e.selectedRowIds.has(o)){l=!1;break}}if(l)e.selectedRowIds.clear();else for(let n=0;n<e.gridData.length;n++){let o=v(e.gridData[n],n);e.selectedRowIds.add(o)}B(),T(),F()}function Pe(t,l,n,o){if(t.stopPropagation(),e.isLoadingData||e.isSavingCell||e.isTransitioningEdit||e.editingCellInfo)return;let a=e.gridData[l]?S(e.gridData[l],n):null;if((t.metaKey||t.ctrlKey)&&t.shiftKey&&e.lastSelectedCell){e.selectedRowIds.clear();let i=Math.min(e.lastSelectedCell.rowIdx,l),s=Math.max(e.lastSelectedCell.rowIdx,l),r=Math.min(e.lastSelectedCell.colIdx,n),m=Math.max(e.lastSelectedCell.colIdx,n),u=new Set;for(let p of e.selectedCells)u.add(`${p.rowIdx},${p.colIdx}`);for(let p=i;p<=s;p++)for(let g=r;g<=m;g++)if(!u.has(`${p},${g}`)){let b=v(e.gridData[p],p),R=S(e.gridData[p],g);e.selectedCells.push({rowIdx:p,colIdx:g,rowId:b,value:R}),u.add(`${p},${g}`)}}else if(t.metaKey||t.ctrlKey){e.selectedRowIds.clear();let i=e.selectedCells.findIndex(s=>s.rowIdx===l&&s.colIdx===n);i>=0?e.selectedCells.splice(i,1):(e.selectedCells.push({rowIdx:l,colIdx:n,rowId:o,value:a}),e.lastSelectedCell={rowIdx:l,colIdx:n})}else if(t.shiftKey&&e.lastSelectedCell){e.selectedRowIds.clear(),e.selectedCells=[];let i=Math.min(e.lastSelectedCell.rowIdx,l),s=Math.max(e.lastSelectedCell.rowIdx,l),r=Math.min(e.lastSelectedCell.colIdx,n),m=Math.max(e.lastSelectedCell.colIdx,n);for(let u=i;u<=s;u++)for(let p=r;p<=m;p++){let g=v(e.gridData[u],u),b=S(e.gridData[u],p);e.selectedCells.push({rowIdx:u,colIdx:p,rowId:g,value:b})}}else e.selectedRowIds.clear(),e.selectedCells=[{rowIdx:l,colIdx:n,rowId:o,value:a}],e.lastSelectedCell={rowIdx:l,colIdx:n},e.selectedColumns.clear();B(),T(),F()}function ie(){e.selectedCells=[],e.selectedRowIds.clear(),e.selectedColumns.clear(),e.lastSelectedCell=null,B(),T(),F()}function Re(t,l,n,o){if(e.cellEditBehavior==="vscode"){let a=e.tableColumns[n];if(!a)return;let i=e.gridData[l];if(!i)return;let s=S(i,n);e.cellPreviewInfo={rowIdx:l,colIdx:n,rowId:o,columnName:a.name,originalValue:s},se()}else e.cellEditBehavior==="modal"?U(l,n,o):Ke(l,n,o)}var ft={async refreshContent(t){return e.isDbConnected&&(await A(),!(e.schemaCache.tables.some(n=>n.name===e.selectedTable)||e.schemaCache.views.some(n=>n.name===e.selectedTable))&&e.selectedTable?(e.selectedTable=null,e.selectedTableType=null,document.getElementById("tableNameLabel").textContent="No table selected",document.getElementById("gridContainer").innerHTML=`
                    <div class="empty-view">
                        <span class="empty-icon codicon codicon-database"></span>
                        <span class="empty-title">Select a table</span>
                        <span class="empty-desc">Choose a table from the sidebar to view data</span>
                    </div>
                `):e.selectedTable&&(await z(),await w(!1))),{success:!0}},async updateColorScheme(t){return document.documentElement.style.colorScheme=t,{success:!0}},async updateCellEditBehavior(t){return e.cellEditBehavior=t,{success:!0}}};function gt(){window.addEventListener("message",t=>{let l=t.data;if(l&&l.kind==="invoke"){let{correlationId:o,methodName:a,parameters:i}=l,s=ft[a];typeof s=="function"?Promise.resolve(s.apply(ft,i||[])).then(r=>{We(o,r)}).catch(r=>{Ce(o,r instanceof Error?r.message:String(r))}):Ce(o,`Unknown method: ${a}`);return}if(!l||l.channel!=="rpc")return;let n=l.content;n&&n.kind==="response"&&Oe(n)})}function O(t){let l=document.getElementById(t);l&&l.classList.remove("hidden")}function D(t){let l=document.getElementById(t);l&&l.classList.add("hidden")}function ht(){if(!e.selectedTable)return;let t=document.getElementById("exportFormat");t&&(t.value="csv");let l=document.getElementById("exportColumns");l&&(l.innerHTML=e.tableColumns.map(n=>`
            <label style="display:flex; align-items:center; gap:3px; margin-bottom:4px; font-size:13px; cursor:pointer;">
                <input type="checkbox" class="export-col-check" value="${y(n.name)}" checked style="margin:0;">
                ${y(n.name)}
            </label>
        `).join("")),Le(),O("exportModal")}function Le(){let t=document.getElementById("exportFormat").value,l=document.getElementById("exportOptions"),n="";t==="csv"||t==="excel"?n+=`
            <label style="display:flex; align-items:center; gap:3px; margin-bottom:4px; font-size:13px; cursor:pointer;">
                <input type="checkbox" id="exportHeader" checked style="margin:0;"> Include Headers
            </label>
        `:t==="sql"&&(n+=`
            <label style="display:flex; align-items:center; gap:3px; margin-bottom:4px; font-size:13px; cursor:pointer;">
                <input type="checkbox" id="exportTableName" checked style="margin:0;"> Include Table Name
            </label>
        `),l.innerHTML=n}async function yt(){let t=document.getElementById("exportFormat").value,l=document.querySelectorAll(".export-col-check:checked"),n=Array.from(l).map(a=>a.value);if(n.length===0){c("Error: Select at least one column");return}let o={};if(t==="csv"||t==="excel"?o.header=document.getElementById("exportHeader")?.checked??!0:t==="sql"&&(o.includeTableName=document.getElementById("exportTableName")?.checked??!0),e.selectedTableType==="table"){let a=Array.from(e.selectedRowIds);a.length>0&&(o.rowIds=a)}try{c("Exporting..."),D("exportModal"),await f.exportTable({table:e.selectedTable},n,null,null,{format:t,...o}),c("Export initiated")}catch(a){console.error("Export failed:",a),c(`Export failed: ${a.message}`)}}function Ct(){if(!e.selectedTable||e.selectedTableType!=="table")return;let t=document.getElementById("addRowForm");t.innerHTML=e.tableColumns.map(l=>{let n=l.notnull===1&&!l.isPrimaryKey,o=n?' <span style="color: var(--error-color)">*</span>':"";return`
        <div class="form-field">
            <label>${y(l.name)}${o} <span style="opacity:0.5">(${l.type})</span></label>
            <input type="text" data-column="${y(l.name)}" data-required="${n}" placeholder="${l.isPrimaryKey?"Auto (Primary Key)":n?"Required":"NULL"}" ${l.isPrimaryKey?"disabled":""}>
        </div>
    `}).join(""),O("addRowModal")}async function wt(){let t=document.querySelectorAll("#addRowForm input[data-column]:not([disabled])"),l=[];for(let o of t){let a=o.dataset.column,i=o.value.trim();o.dataset.required==="true"&&(i===""||i.toLowerCase()==="null")?(l.push(a),o.style.borderColor="var(--error-color)"):o.style.borderColor=""}if(l.length>0){c(`Required fields missing: ${l.join(", ")}`);return}let n={};for(let o of t){let a=o.dataset.column,i=o.value.trim();i!==""&&(i.toLowerCase()==="null"?n[a]=null:!isNaN(Number(i))&&i!==""?n[a]=Number(i):n[a]=i)}try{c("Inserting row..."),await f.insertRow(e.selectedTable,n),D("addRowModal"),await w(),c("Row inserted - Ctrl+S to save")}catch(o){console.error("Insert failed:",o),c(`Error: ${o.message}`)}}function bt(){if(e.selectedColumns.size>0){let t=Array.from(e.selectedColumns);document.getElementById("deleteConfirmText").textContent=`Are you sure you want to delete ${t.length} column${t.length>1?"s":""} (${t.join(", ")})? This will permanently remove the column${t.length>1?"s":""} and all their data.`}else if(e.selectedRowIds.size>0)document.getElementById("deleteConfirmText").textContent=`Are you sure you want to delete ${e.selectedRowIds.size} row${e.selectedRowIds.size>1?"s":""}?`;else return;O("deleteModal")}async function de(){e.selectedColumns.size>0?await qt():e.selectedRowIds.size>0&&await Vt()}async function Vt(){if(e.selectedRowIds.size===0)return;let t=Array.from(e.selectedRowIds);try{c("Deleting rows..."),await f.deleteRows(e.selectedTable,t),D("deleteModal"),e.selectedRowIds.clear(),await w(),T(),c(`Deleted ${t.length} row${t.length>1?"s":""} - Ctrl+S to save`)}catch(l){console.error("Delete rows failed:",l),c(`Error: ${l.message}`)}}async function qt(){if(e.selectedColumns.size===0)return;let t=Array.from(e.selectedColumns);try{c("Deleting columns..."),await f.deleteColumns(e.selectedTable,t),D("deleteModal"),e.selectedColumns.clear(),e.selectedCells=[],e.lastSelectedCell=null,await A(),await z(),await w(),T(),c(`Deleted ${t.length} column${t.length>1?"s":""} - Ctrl+S to save`)}catch(l){console.error("Delete columns failed:",l),c(`Error: ${l.message}`)}}var xt=0;function vt(){document.getElementById("newTableName").value="",document.getElementById("columnDefinitions").innerHTML="",xt=0,Be(!0),O("createTableModal")}function Be(t=!1){let l=document.getElementById("columnDefinitions"),n=++xt,o=`
        <div class="column-def-row" id="colDef_${n}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
            <input type="text" placeholder="Column name" class="col-name" style="flex: 2;" value="${t?"id":""}">
            <select class="col-type" style="flex: 1;">
                <option value="INTEGER" ${t?"selected":""}>INTEGER</option>
                <option value="TEXT" ${t?"":"selected"}>TEXT</option>
                <option value="REAL">REAL</option>
                <option value="BLOB">BLOB</option>
                <option value="NUMERIC">NUMERIC</option>
            </select>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="checkbox" class="col-pk" ${t?"checked":""} style="margin:0;"> PK
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="checkbox" class="col-nn" style="margin:0;"> NN
            </label>
            <button class="icon-button" onclick="removeColumnDefinition(${n})" title="Remove" ${t?"disabled":""}>
                <span class="codicon codicon-close"></span>
            </button>
        </div>
    `;l.insertAdjacentHTML("beforeend",o)}function It(t){let l=document.getElementById(`colDef_${t}`);l&&l.remove()}async function Et(){let t=document.getElementById("newTableName").value.trim();if(!t){c("Error: Table name is required");return}if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t)){c("Error: Invalid table name");return}let l=[],n=document.querySelectorAll(".column-def-row");for(let o of n){let a=o.querySelector(".col-name").value.trim(),i=o.querySelector(".col-type").value,s=o.querySelector(".col-pk").checked,r=o.querySelector(".col-nn").checked;a&&l.push({name:a,type:i,primaryKey:s,notNull:r})}if(l.length===0){c("Error: At least one column is required");return}try{c("Creating table..."),await f.createTable(t,l),D("createTableModal"),await A(),c(`Table "${t}" created - Ctrl+S to save`)}catch(o){console.error("Create table failed:",o),c(`Error: ${o.message}`)}}function Tt(){!e.selectedTable||e.selectedTableType!=="table"||(document.getElementById("newColumnName").value="",document.getElementById("newColumnType").value="TEXT",document.getElementById("newColumnDefault").value="",O("addColumnModal"))}async function St(){let t=document.getElementById("newColumnName").value.trim(),l=document.getElementById("newColumnType").value,n=document.getElementById("newColumnDefault").value.trim();if(!t){c("Error: Column name is required");return}if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t)){c("Error: Invalid column name");return}try{c("Adding column..."),await f.addColumn(e.selectedTable,t,l,n),D("addColumnModal"),await z(),await w(),c(`Column "${t}" added - Ctrl+S to save`)}catch(o){console.error("Add column failed:",o),c(`Error: ${o.message}`)}}async function $t(){if(e.selectedCells.length!==0)try{let t;if(e.selectedCells.length===1){let l=e.selectedCells[0].value;l==null?t="":l instanceof Uint8Array?t="[BLOB]":t=String(l)}else{let l=[...new Set(e.selectedCells.map(i=>i.rowIdx))].sort((i,s)=>i-s),n=[...new Set(e.selectedCells.map(i=>i.colIdx))].sort((i,s)=>i-s),o=new Map;for(let i of e.selectedCells)o.set(`${i.rowIdx},${i.colIdx}`,i.value);let a=[];for(let i of l){let s=[];for(let r of n){let m=`${i},${r}`,u=o.has(m)?o.get(m):"";u==null?u="":u instanceof Uint8Array?u="[BLOB]":(u=String(u),u=u.replace(/\t/g," ").replace(/\n/g," ")),s.push(u)}a.push(s.join("	"))}t=a.join(`
`)}await navigator.clipboard.writeText(t),c(`Copied ${e.selectedCells.length} cell${e.selectedCells.length>1?"s":""}`)}catch(t){console.error("Copy failed:",t),c("Copy failed: "+t.message)}}async function Pt(){if(e.selectedRowIds.size!==0)try{let t=[];for(let o=0;o<e.gridData.length;o++){let a=e.gridData[o],i;if(e.selectedTableType==="table"?i=a[0]:i=e.currentPageIndex*e.rowsPerPage+o,e.selectedRowIds.has(i)){let s=e.selectedTableType==="table"?1:0,r=a.slice(s).map(m=>m==null?"":m instanceof Uint8Array?"[BLOB]":String(m));t.push(r.join("	"))}}let n=[e.tableColumns.map(o=>o.name).join("	"),...t].join(`
`);await navigator.clipboard.writeText(n),c(`Copied ${t.length} row${t.length>1?"s":""} to clipboard`)}catch(t){console.error("Copy failed:",t),c("Copy failed: "+t.message)}}async function Rt(){if(e.selectedCells.length!==0){if(e.selectedTableType!=="table"){c("Views are read-only");return}try{c("Clearing cells...");let t=[];for(let n of e.selectedCells){let o=e.tableColumns[n.colIdx];if(!o)continue;let i=o.notnull===1?"":null;t.push({rowId:n.rowId,column:o.name,value:i,originalValue:n.value,rowIdx:n.rowIdx,colIdx:n.colIdx})}let l=`Clear ${t.length} cell${t.length>1?"s":""}`;await f.updateCellBatch(e.selectedTable,t,l);for(let n of t)e.gridData[n.rowIdx][n.colIdx+I()]=n.value;e.selectedCells=[],e.lastSelectedCell=null,e.selectedColumns.clear(),await w(),T(),c(`${l} - Ctrl+S to save`)}catch(t){console.error("Clear cells failed:",t),c(`Clear failed: ${t.message}`)}}}async function Lt(){let t=document.getElementById("settingsModal");t&&(t.classList.remove("hidden"),await De())}async function De(){let t=document.getElementById("pragmaSettingsContainer");t.innerHTML='<div class="loading-spinner"></div> Loading settings...';try{let[l,n]=await Promise.all([f.getPragmas(),f.getExtensionSettings()]);Ht(l,n)}catch(l){console.error("Failed to load settings:",l),t.innerHTML=`<div style="color: var(--error-color)">Error loading settings: ${l.message}</div>`}}function Ht(t,l){let n=document.getElementById("pragmaSettingsContainer");if(!n)return;let o=(i,s)=>i.map(r=>`<option value="${r}" ${String(s).toUpperCase()===String(r).toUpperCase()?"selected":""}>${r}</option>`).join(""),a="";a+='<div class="setting-section-title" style="font-weight:600;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border-color)">Extension Settings</div>',a+=`
        <div class="form-field">
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                <input type="checkbox" ${l.autoCommit?"checked":""} onchange="updateExtensionSetting('autoCommit', this.checked)" style="margin:0;">
                Auto-Commit Changes
            </label>
            <div class="setting-desc">Automatically save changes to disk immediately. If disabled, you must save manually (Ctrl+S).</div>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Double Click Behavior</label>
            <select onchange="updateExtensionSetting('doubleClickBehavior', this.value)">
                ${o(["inline","modal","vscode"],l.cellEditBehavior)}
            </select>
            <div class="setting-desc">Action when double-clicking a cell</div>
        </div>
    `,a+='<div class="setting-section-title" style="font-weight:600;margin:16px 0 8px 0;padding-bottom:4px;border-bottom:1px solid var(--border-color)">SQLite Settings (Pragmas)</div>',a+=`
        <div class="form-field">
            <label>Journal Mode</label>
            <select onchange="updatePragma('journal_mode', this.value)">
                ${o(["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"],t.journal_mode)}
            </select>
            <div class="setting-desc">Database journaling mode (WAL is recommended for concurrency)</div>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Foreign Keys</label>
            <select onchange="updatePragma('foreign_keys', this.value === 'true' ? 1 : 0)">
                <option value="true" ${Number(t.foreign_keys)===1?"selected":""}>ON</option>
                <option value="false" ${Number(t.foreign_keys)===0?"selected":""}>OFF</option>
            </select>
            <div class="setting-desc">Enforce foreign key constraints</div>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Synchronous</label>
            <select onchange="updatePragma('synchronous', this.value)">
                <option value="0" ${Number(t.synchronous)===0?"selected":""}>OFF (0)</option>
                <option value="1" ${Number(t.synchronous)===1?"selected":""}>NORMAL (1)</option>
                <option value="2" ${Number(t.synchronous)===2?"selected":""}>FULL (2)</option>
                <option value="3" ${Number(t.synchronous)===3?"selected":""}>EXTRA (3)</option>
            </select>
            <div class="setting-desc">Disk synchronization safety level</div>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Locking Mode</label>
            <select onchange="updatePragma('locking_mode', this.value)">
                ${o(["NORMAL","EXCLUSIVE"],t.locking_mode)}
            </select>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Auto Vacuum</label>
            <select onchange="updatePragma('auto_vacuum', this.value)">
                <option value="0" ${Number(t.auto_vacuum)===0?"selected":""}>NONE (0)</option>
                <option value="1" ${Number(t.auto_vacuum)===1?"selected":""}>FULL (1)</option>
                <option value="2" ${Number(t.auto_vacuum)===2?"selected":""}>INCREMENTAL (2)</option>
            </select>
        </div>
    `,a+=`
        <div class="form-field">
            <label>Cache Size</label>
            <input type="number" value="${t.cache_size}" onchange="updatePragma('cache_size', Number(this.value))">
            <div class="setting-desc">Number of pages (positive) or kilobytes (negative)</div>
        </div>
    `,n.innerHTML=a}async function Bt(t,l){try{await f.updateExtensionSetting(t,l),c(`Updated ${t}`)}catch(n){console.error(`Failed to set ${t}:`,n),c(`Error: ${n.message}`),await De()}}async function Dt(t,l){try{c(`Updating ${t}...`),await f.setPragma(t,l),c(`Updated ${t}`)}catch(n){console.error(`Failed to set ${t}:`,n),c(`Error: ${n.message}`),await De()}}function Nt(){let t=document.getElementById("gridContainer");if(!t){console.error("gridContainer not found");return}document.addEventListener("dragover",l=>l.preventDefault()),document.addEventListener("drop",l=>l.preventDefault()),t.addEventListener("dragover",Kt),t.addEventListener("dragleave",jt),t.addEventListener("drop",_t)}var P=null;function Kt(t){t.preventDefault(),t.dataTransfer.dropEffect="copy";let l=t.target.closest(".data-cell");l&&!l.classList.contains("row-number")?(P&&P!==l&&P.classList.remove("drag-over"),l.classList.add("drag-over"),P=l):P&&(P.classList.remove("drag-over"),P=null)}function jt(t){t.target}async function _t(t){t.preventDefault(),P&&(P.classList.remove("drag-over"),P=null);let l=t.target.closest(".data-cell");if(!l||l.classList.contains("row-number"))return;if(t.dataTransfer.files.length>0){let o=t.dataTransfer.files[0];await Jt(l,o.name,o);return}let n=t.dataTransfer.getData("text/uri-list");if(n){let o=n.split(/\r?\n/);if(o.length>0&&o[0]){let a=o[0],i="unknown_file";try{let s=a.split("/");i=decodeURIComponent(s[s.length-1])}catch(s){console.warn("Failed to parse name from URI",s)}await Xt(l,i,a);return}}}async function Jt(t,l,n){try{c(`Reading ${l}...`);let o=await Gt(n),a=new Uint8Array(o);await kt(t,l,a)}catch(o){console.error("File read failed:",o),c(`File read failed: ${o.message}`)}}async function Xt(t,l,n){try{c(`Fetching ${l}...`);let o=await f.readWorkspaceFileUri(n),a;if(o instanceof Uint8Array)a=o;else if(o&&o.type==="Buffer"&&Array.isArray(o.data))a=new Uint8Array(o.data);else if(o&&typeof o=="object"&&Object.keys(o).some(i=>!isNaN(i)))a=new Uint8Array(Object.values(o));else throw console.error("Unknown data format from backend:",o),new Error("Received invalid data format from backend");await kt(t,l,a)}catch(o){console.error("URI upload failed:",o),c(`Upload failed: ${o.message}`)}}async function kt(t,l,n){let o=parseInt(t.dataset.rowidx,10),a=parseInt(t.dataset.colidx,10);if(!e.gridData)return;let i=e.gridData[o];if(!i)return;let s=v(i,o),r=e.tableColumns[a];if(e.selectedTableType!=="table"){c("Cannot upload to a view");return}try{c(`Uploading ${l} (${Qt(n.byteLength)})...`);let m=i[a+I()];await f.updateCell(e.selectedTable,s,r.name,n,m),e.gridData[o][a+I()]=n,Zt(t,n),c(`Uploaded ${l}`)}catch(m){console.error("Upload failed:",m),c(`Upload failed: ${m.message}`)}}function Gt(t){return new Promise((l,n)=>{let o=new FileReader;o.onload=()=>l(o.result),o.onerror=()=>n(o.error),o.readAsArrayBuffer(t)})}function Qt(t){if(t===0)return"0 B";let l=1024,n=["B","KB","MB","GB"],o=Math.floor(Math.log(t)/Math.log(l));return parseFloat((t/Math.pow(l,o)).toFixed(2))+" "+n[o]}function Zt(t,l){let n=K(l),o=!0,a=`<span class="cell-text">${n}</span>`;a+='<span class="expand-icon codicon codicon-link-external" title="View full content"></span>',t.innerHTML=a,t.classList.remove("null-value")}gt();Object.assign(window,{reloadFromDisk:at,toggleSection:nt,selectTableItem:ot,openCreateTableModal:vt,openAddRowModal:Ct,openAddColumnModal:Tt,openDeleteModal:bt,submitAddRow:wt,submitDelete:de,submitCreateTable:Et,addColumnDefinition:Be,removeColumnDefinition:It,submitAddColumn:St,openExportModal:ht,submitExport:yt,onExportFormatChange:Le,onFilterChange:it,onPageSizeChange:rt,onDateFormatChange:ct,goToPage:dt,onColumnSort:xe,onColumnHeaderClick:Ie,toggleColumnPin:Ee,onColumnFilterKeydown:ve,applyColumnFilter:re,startColumnResize:Se,onRowClick:pt,onRowNumberClick:$e,toggleRowPin:Te,onSelectAllClick:ce,onCellClick:Pe,onCellDoubleClick:Re,openCellPreview:U,closeCellPreview:j,saveCellPreview:we,formatCellPreviewJson:Ge,compactCellPreviewJson:Qe,toggleCellPreviewWrap:Ze,openCellInVsCode:se,openSettingsModal:Lt,updateExtensionSetting:Bt,updatePragma:Dt,applyBatchUpdate:et,setBatchNull:tt,toggleBatchPatch:lt,closeModal:D});async function Yt(){try{let t=document.getElementById("vscode-env");t&&t.dataset.cellEditBehavior&&(e.cellEditBehavior=t.dataset.cellEditBehavior),c("Connecting to database...");let l=await f.initialize();if(!l||!l.connected)throw new Error("Failed to connect to database");e.isDbConnected=!0,await f.ping(),await A(),c("Ready"),qe(),He(),st(),Nt(),document.addEventListener("keydown",async n=>{if(n.key==="Escape"&&!e.editingCellInfo&&!document.querySelector(".modal:not(.hidden)")&&ie(),(n.metaKey||n.ctrlKey)&&n.key==="c"){if(e.editingCellInfo||document.activeElement.tagName==="INPUT")return;e.selectedCells.length>0?(n.preventDefault(),await $t()):e.selectedRowIds.size>0&&(n.preventDefault(),await Pt())}if((n.metaKey||n.ctrlKey)&&n.key==="a"){if(e.editingCellInfo||document.activeElement.tagName==="INPUT")return;e.selectedTable&&(n.preventDefault(),ce(n))}if((n.metaKey||n.ctrlKey)&&(n.key==="Delete"||n.key==="Backspace")){if(e.editingCellInfo||document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")return;e.selectedTable&&e.selectedTableType==="table"&&(n.preventDefault(),e.selectedColumns.size>0?await de():e.selectedRowIds.size>0?await de():e.selectedCells.length>0&&await Rt())}})}catch(t){console.error("Init error:",t),ne(t.message)}}Yt();})();

    </script>
    <!--BODY-->
</body>
</html>
